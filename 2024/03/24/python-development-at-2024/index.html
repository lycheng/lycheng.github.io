

<!DOCTYPE html>
<html lang="en" data-default-color-scheme=auto>



<head>
  <meta charset="UTF-8">
  <link rel="apple-touch-icon" sizes="76x76" href="/img/fluid.png">
  <link rel="icon" href="/img/fluid.png">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, shrink-to-fit=no">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  
  <meta name="theme-color" content="#2f4154">
  <meta name="author" content="Shing">
  <meta name="keywords" content="Golang, Python, Engineering">
  
    <meta name="description" content="Intro与之对比是 2020 年左右自己 Python 开发相关技术栈，那时以 Python 3.6 为主，主要做 Flask Web 开发。现在则是以 Python 3.10 作为新的版本来进行学习。 本文会涉及一些我觉得挺重要的一些改动，包括  语法上的更新 async &#x2F; await 框架和工具  Language ChangesPEP 557 Data Classes以前没怎么">
<meta property="og:type" content="article">
<meta property="og:title" content="Python Development At 2024">
<meta property="og:url" content="http://yoursite.com/2024/03/24/python-development-at-2024/index.html">
<meta property="og:site_name" content="Shing&#39;s logs">
<meta property="og:description" content="Intro与之对比是 2020 年左右自己 Python 开发相关技术栈，那时以 Python 3.6 为主，主要做 Flask Web 开发。现在则是以 Python 3.10 作为新的版本来进行学习。 本文会涉及一些我觉得挺重要的一些改动，包括  语法上的更新 async &#x2F; await 框架和工具  Language ChangesPEP 557 Data Classes以前没怎么">
<meta property="og:locale" content="en_US">
<meta property="article:published_time" content="2024-03-23T16:00:00.000Z">
<meta property="article:modified_time" content="2024-03-24T15:51:38.507Z">
<meta property="article:author" content="Shing">
<meta property="article:tag" content="python">
<meta name="twitter:card" content="summary_large_image">
  
  
  
  <title>Python Development At 2024 - Shing&#39;s logs</title>

  <link  rel="stylesheet" href="https://lib.baomitu.com/twitter-bootstrap/4.6.1/css/bootstrap.min.css" />



  <link  rel="stylesheet" href="https://lib.baomitu.com/github-markdown-css/4.0.0/github-markdown.min.css" />

  <link  rel="stylesheet" href="https://lib.baomitu.com/hint.css/2.7.0/hint.min.css" />

  <link  rel="stylesheet" href="https://lib.baomitu.com/fancybox/3.5.7/jquery.fancybox.min.css" />



<!-- 主题依赖的图标库，不要自行修改 -->
<!-- Do not modify the link that theme dependent icons -->

<link rel="stylesheet" href="//at.alicdn.com/t/font_1749284_hj8rtnfg7um.css">



<link rel="stylesheet" href="//at.alicdn.com/t/font_1736178_lbnruvf0jn.css">


<link  rel="stylesheet" href="/css/main.css" />


  <link id="highlight-css" rel="stylesheet" href="/css/highlight.css" />
  
    <link id="highlight-css-dark" rel="stylesheet" href="/css/highlight-dark.css" />
  




  <script id="fluid-configs">
    var Fluid = window.Fluid || {};
    Fluid.ctx = Object.assign({}, Fluid.ctx)
    var CONFIG = {"hostname":"yoursite.com","root":"/","version":"1.9.5","typing":{"enable":true,"typeSpeed":70,"cursorChar":"_","loop":false,"scope":[]},"anchorjs":{"enable":true,"element":"h1,h2,h3,h4,h5,h6","placement":"left","visible":"hover","icon":""},"progressbar":{"enable":true,"height_px":3,"color":"#29d","options":{"showSpinner":false,"trickleSpeed":100}},"code_language":{"enable":true,"default":"TEXT"},"copy_btn":true,"image_caption":{"enable":true},"image_zoom":{"enable":true,"img_url_replace":["",""]},"toc":{"enable":true,"placement":"right","headingSelector":"h1,h2,h3,h4,h5,h6","collapseDepth":0},"lazyload":{"enable":true,"loading_img":"/img/loading.gif","onlypost":false,"offset_factor":2},"web_analytics":{"enable":false,"follow_dnt":true,"baidu":null,"google":{"measurement_id":null},"tencent":{"sid":null,"cid":null},"woyaola":null,"cnzz":null,"leancloud":{"app_id":null,"app_key":null,"server_url":null,"path":"window.location.pathname","ignore_local":false}},"search_path":"/local-search.xml","include_content_in_search":true};

    if (CONFIG.web_analytics.follow_dnt) {
      var dntVal = navigator.doNotTrack || window.doNotTrack || navigator.msDoNotTrack;
      Fluid.ctx.dnt = dntVal && (dntVal.startsWith('1') || dntVal.startsWith('yes') || dntVal.startsWith('on'));
    }
  </script>
  <script  src="/js/utils.js" ></script>
  <script  src="/js/color-schema.js" ></script>
  


  
<meta name="generator" content="Hexo 6.3.0"></head>


<body>
  

  <header>
    

<div class="header-inner" style="height: 70vh;">
  <nav id="navbar" class="navbar fixed-top  navbar-expand-lg navbar-dark scrolling-navbar">
  <div class="container">
    <a class="navbar-brand" href="/">
      <strong>Shing&#39;s Logs</strong>
    </a>

    <button id="navbar-toggler-btn" class="navbar-toggler" type="button" data-toggle="collapse"
            data-target="#navbarSupportedContent"
            aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
      <div class="animated-icon"><span></span><span></span><span></span></div>
    </button>

    <!-- Collapsible content -->
    <div class="collapse navbar-collapse" id="navbarSupportedContent">
      <ul class="navbar-nav ml-auto text-center">
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/">
                <i class="iconfont icon-home-fill"></i>
                <span>Home</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/archives/">
                <i class="iconfont icon-archive-fill"></i>
                <span>Archives</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/categories/">
                <i class="iconfont icon-category-fill"></i>
                <span>Categories</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/tags/">
                <i class="iconfont icon-tags-fill"></i>
                <span>Tags</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/about/">
                <i class="iconfont icon-user-fill"></i>
                <span>About</span>
              </a>
            </li>
          
        
        
          <li class="nav-item" id="search-btn">
            <a class="nav-link" target="_self" href="javascript:;" data-toggle="modal" data-target="#modalSearch" aria-label="Search">
              <i class="iconfont icon-search"></i>
            </a>
          </li>
          
        
        
          <li class="nav-item" id="color-toggle-btn">
            <a class="nav-link" target="_self" href="javascript:;" aria-label="Color Toggle">
              <i class="iconfont icon-dark" id="color-toggle-icon"></i>
            </a>
          </li>
        
      </ul>
    </div>
  </div>
</nav>

  

<div id="banner" class="banner" parallax=true
     style="background: url('/img/default.png') no-repeat center center; background-size: cover;">
  <div class="full-bg-img">
    <div class="mask flex-center" style="background-color: rgba(0, 0, 0, 0.3)">
      <div class="banner-text text-center fade-in-up">
        <div class="h2">
          
            <span id="subtitle" data-typed-text="Python Development At 2024"></span>
          
        </div>

        
          
  <div class="mt-3">
    
    
      <span class="post-meta">
        <i class="iconfont icon-date-fill" aria-hidden="true"></i>
        <time datetime="2024-03-24 00:00" pubdate>
          March 24, 2024 am
        </time>
      </span>
    
  </div>

  <div class="mt-1">
    
      <span class="post-meta mr-2">
        <i class="iconfont icon-chart"></i>
        
          8k words
        
      </span>
    

    
      <span class="post-meta mr-2">
        <i class="iconfont icon-clock-fill"></i>
        
        
        
          68 mins
        
      </span>
    

    
    
  </div>


        
      </div>

      
    </div>
  </div>
</div>

</div>

  </header>

  <main>
    
      

<div class="container-fluid nopadding-x">
  <div class="row nomargin-x">
    <div class="side-col d-none d-lg-block col-lg-2">
      

    </div>

    <div class="col-lg-8 nopadding-x-md">
      <div class="container nopadding-x-md" id="board-ctn">
        <div id="board">
          <article class="post-content mx-auto">
            <h1 id="seo-header">Python Development At 2024</h1>
            
            
              <div class="markdown-body">
                
                <h2 id="Intro"><a href="#Intro" class="headerlink" title="Intro"></a>Intro</h2><p>与之对比是 2020 年左右自己 Python 开发相关技术栈，那时以 Python 3.6 为主，主要做 Flask Web 开发。现在则是以 Python 3.10 作为新的版本来进行学习。</p>
<p>本文会涉及一些我觉得挺重要的一些改动，包括</p>
<ul>
<li>语法上的更新</li>
<li>async &#x2F; await</li>
<li>框架和工具</li>
</ul>
<h2 id="Language-Changes"><a href="#Language-Changes" class="headerlink" title="Language Changes"></a>Language Changes</h2><h3 id="PEP-557-Data-Classes"><a href="#PEP-557-Data-Classes" class="headerlink" title="PEP 557 Data Classes"></a>PEP 557 Data Classes</h3><p>以前没怎么太详细读过 PEP，这次认真看了几个，第一次从语言开发者的角度了解语言 feature 前后，感觉也不错。</p>
<p>在讲 PEP 557 之前需要了解下 PEP 526。PEP 526 主要讲的是 variable annotation。之前在 Python 3.6 阶段已经有了 PEP 484，但其更多关注是类型推断。PEP 526 则更进一步扩展到 class and instance variable 用途上。</p>
<p>其中一个重要用途</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">class</span> <span class="hljs-title class_">BasicStarship</span>:<br>    captain: <span class="hljs-built_in">str</span> = <span class="hljs-string">&#x27;Picard&#x27;</span>               <span class="hljs-comment"># instance variable with default</span><br>    damage: <span class="hljs-built_in">int</span>                           <span class="hljs-comment"># instance variable without default</span><br>    stats: ClassVar[<span class="hljs-type">Dict</span>[<span class="hljs-built_in">str</span>, <span class="hljs-built_in">int</span>]] = &#123;&#125;  <span class="hljs-comment"># class variable</span><br><br>bss = BasicStarship()<br><span class="hljs-built_in">print</span>(<span class="hljs-built_in">vars</span>(bss))  <span class="hljs-comment"># &#123;&#125;, instance without attribute</span><br></code></pre></td></tr></table></figure>

<p>上述代码中，能通过 type annotation 标记出其是属于 instance 还是 class 的 variable。但需要注意的是，这种 type annotaition 属于标记，并不会影响实际程序逻辑，即上述的代码中，<code>captain</code> 依旧还是 class variable。直到 PEP 557 则可以借助类装饰器来更好的完成类定义。</p>
<blockquote>
<p>A class decorator is provided which inspects a class definition for variables with type annotations as defined in <a target="_blank" rel="noopener" href="https://peps.python.org/pep-0526/" title="PEP 526 – Syntax for Variable Annotations">PEP 526</a>, “Syntax for Variable Annotations”.</p>
</blockquote>
<p>同样是上述例子</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-meta">@dataclass</span><br><span class="hljs-keyword">class</span> <span class="hljs-title class_">BasicStarship</span>:<br>    damage: <span class="hljs-built_in">int</span>                           <span class="hljs-comment"># instance variable without default</span><br>    captain: <span class="hljs-built_in">str</span> = <span class="hljs-string">&#x27;Picard&#x27;</span>               <span class="hljs-comment"># instance variable with default</span><br>    stats: ClassVar[<span class="hljs-type">Dict</span>[<span class="hljs-built_in">str</span>, <span class="hljs-built_in">int</span>]] = &#123;&#125;  <span class="hljs-comment"># class variable</span><br><br><br>bss = BasicStarship(damage=<span class="hljs-number">1</span>)<br><br><span class="hljs-built_in">print</span>(<span class="hljs-built_in">vars</span>(bss))  <span class="hljs-comment"># &#123;&#x27;damage&#x27;: 1, &#x27;captain&#x27;: &#x27;Picard&#x27;&#125;</span><br></code></pre></td></tr></table></figure>

<p>这里的关键是，这个类装饰器可以帮你自动实现如 <code>__init__</code> 和 <code>__ne__</code> 等一些常用的 magic method。这一特性可以更方便实现一些只需要进行序列化和反序列化的类。此外借助 dataclass 的 <code>field</code> 可以对不同的属性进行定制。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-meta">@dataclass</span><br><span class="hljs-keyword">class</span> <span class="hljs-title class_">D</span>:<br>    x: <span class="hljs-built_in">list</span> = field(default_factory=<span class="hljs-built_in">list</span>)  <span class="hljs-comment"># init the mutable variable</span><br>    y: <span class="hljs-built_in">int</span> = field(<span class="hljs-built_in">repr</span>=<span class="hljs-literal">False</span>, default=<span class="hljs-number">10</span>)<br>    z: <span class="hljs-built_in">int</span> = <span class="hljs-number">20</span><br><br><br><span class="hljs-keyword">assert</span> D().x <span class="hljs-keyword">is</span> <span class="hljs-keyword">not</span> D().x  <span class="hljs-comment"># True</span><br><br><span class="hljs-built_in">print</span>(<span class="hljs-built_in">vars</span>(D()))  <span class="hljs-comment"># &#123;&#x27;x&#x27;: [], &#x27;y&#x27;: 10, &#x27;z&#x27;: 20&#125;</span><br></code></pre></td></tr></table></figure>
<p>更多用法请参考 dataclasses 的文档。</p>
<h3 id="PEP-636-Structural-Pattern-Matching"><a href="#PEP-636-Structural-Pattern-Matching" class="headerlink" title="PEP 636 Structural Pattern Matching"></a>PEP 636 Structural Pattern Matching</h3><p>这个是我最感兴趣的特性，在 Python 3.10 引入。模式匹配这个语法层面的支持可能不同语言都大差不差，但看了下一些样例，能很好支持 Python 已有的 packing &#x2F; unpacking 的语法。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">match</span> command.split():<br>    <span class="hljs-keyword">case</span> [<span class="hljs-string">&quot;quit&quot;</span>]:<br>        <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;Goodbye!&quot;</span>)<br>        quit_game()<br>    <span class="hljs-keyword">case</span> [<span class="hljs-string">&quot;look&quot;</span>]:<br>        current_room.describe()<br>    <span class="hljs-keyword">case</span> [<span class="hljs-string">&quot;get&quot;</span>, obj]:<br>        character.get(obj, current_room)<br>    <span class="hljs-keyword">case</span> [<span class="hljs-string">&quot;go&quot;</span>, direction] <span class="hljs-keyword">if</span> direction <span class="hljs-keyword">in</span> current_room.exits: <span class="hljs-comment"># if guard</span><br>        current_room = current_room.neighbor(direction)<br>    <span class="hljs-keyword">case</span> [<span class="hljs-string">&quot;drop&quot;</span>, *objects]:<br>	    <span class="hljs-built_in">print</span>(objects)<br>    <span class="hljs-keyword">case</span> [<span class="hljs-string">&quot;north&quot;</span>] | [<span class="hljs-string">&quot;go&quot;</span>, <span class="hljs-string">&quot;north&quot;</span>]:  <span class="hljs-comment"># OR pattern</span><br>        current_room = current_room.neighbor(<span class="hljs-string">&quot;north&quot;</span>)<br>    <span class="hljs-keyword">case</span> _:<br>        <span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;Sorry, I couldn&#x27;t understand <span class="hljs-subst">&#123;command!r&#125;</span>&quot;</span>)<br></code></pre></td></tr></table></figure>
<h3 id="Dict-Keys-Ordering"><a href="#Dict-Keys-Ordering" class="headerlink" title="Dict Keys Ordering"></a>Dict Keys Ordering</h3><p>这个功能的更新记录</p>
<blockquote>
<p>Dictionaries preserve insertion order. Note that updating a key does not affect the order. Keys added after deletion are inserted at the end.</p>
</blockquote>
<blockquote>
<p>Changed in version 3.7: Dictionary order is guaranteed to be insertion order. This behavior was an implementation detail of CPython from 3.6.</p>
</blockquote>
<blockquote>
<p>Changed in version 3.8: Dictionaries are now reversible.</p>
</blockquote>
<p>当时出的时候还关注了一下，但实际需要用到已经是 2024 年了，在实际写需要这个功能的时候，第一反应其实是 <code>OrderedDict</code>。现在回想起来，在这种不断进步的时代，所谓经验有时候的确会变成阻碍。现在已经是 3.1X 的版本了，已经不需要考虑这个东西是不是会存在前向兼容的问题了。</p>
<h2 id="Async"><a href="#Async" class="headerlink" title="Async"></a>Async</h2><p>async 相关功能引入实际上是在 3.5 版本。但在 2019 年主要用着 3.6，项目实际上还是以 Flask 为主，并没有相应的尝试。但在 2024 年这个时间点，async 的使用则是广泛了许多。async &#x2F; await 是新引进的两个 keyword，asyncio 则是在新语法基础上，为 Python 编写相应 async 功能的支持库。</p>
<blockquote>
<p>Coroutines are a more generalized form of subroutines. Subroutines are entered at one point and exited at another point. Coroutines can be entered, exited, and resumed at many different points. They can be implemented with the async def statement.</p>
</blockquote>
<blockquote>
<p>Coroutines behave like generators. In older versions of Python, coroutines are defined by generators.</p>
</blockquote>
<p>其实有过 async &#x2F; await 类似 pattern 的其它语言使用经验可以很快接受，PEP 492 也说了采用这种语法是因为其它语言也是这么做的，里面也介绍了很多新 async magic method 应用例子。</p>
<p>这里主要想讲下 ASGI。</p>
<h3 id="ASGI"><a href="#ASGI" class="headerlink" title="ASGI"></a>ASGI</h3><p>和以前的 WSGI 相比</p>
<blockquote>
<p>The WSGI specification has worked well since it was introduced, and allowed for great flexibility in Python framework and web server choice. However, its design is irrevocably tied to the HTTP-style request&#x2F;response cycle, and more and more protocols that do not follow this pattern are becoming a standard part of web programming (most notably, WebSocket).</p>
</blockquote>
<blockquote>
<p>Unlike WSGI, however, applications are asynchronous callables rather than simple callables, and they communicate with the server by receiving and sending asynchronous event messages rather than receiving a single input stream and returning a single iterable.</p>
</blockquote>
<p>WSGI 只专注于一个请求的上下文。</p>
<p>ASGI 关注一个连接上下文，根据不同的 scope 和 event 能处理好不同协议的不同流程，不再仅仅局限于 HTTP，也可以支持如 WebSocket 和 HTTP2。</p>
<blockquote>
<p>ASGI decomposes protocols into a series of events that an application must receive and react to, and events the application might send in response.</p>
</blockquote>
<blockquote>
<p>ASGI is structured as a single, asynchronous callable. It takes a <code>scope</code>, which is a <code>dict</code> containing details about the specific connection, <code>send</code>, an asynchronous callable, that lets the application send event messages to the client, and <code>receive</code>, an asynchronous callable which lets the application receive event messages from the client.</p>
</blockquote>
<p>一段不借助 web framework 的代码</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">async</span> <span class="hljs-keyword">def</span> <span class="hljs-title function_">application</span>(<span class="hljs-params">scope, receive, send</span>):<br>    event = <span class="hljs-keyword">await</span> receive()<br>    ...<br>    <span class="hljs-keyword">await</span> send(&#123;<span class="hljs-string">&quot;type&quot;</span>: <span class="hljs-string">&quot;websocket.send&quot;</span>, ...&#125;)<br></code></pre></td></tr></table></figure>

<p>不同协议，events 有多种，每个 event 是一个 dict，都包含一个指明类型的 <code>type</code> 字段。如对于 HTTP</p>
<ul>
<li><code>http.request</code></li>
<li><code>http.disconnect</code></li>
</ul>
<p>对于 WebSocket</p>
<ul>
<li><code>websocket.connect</code></li>
<li><code>websocket.send</code></li>
<li><code>websocket.receive</code></li>
<li><code>websocket.disconnect</code></li>
</ul>
<p>以下是用 starlette 来编写的样例，需要注意的是，去到 framework 阶段，我们就可以借助 framework 更好的与 scope &#x2F; receive 打交道</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-comment"># app.py</span><br><span class="hljs-keyword">from</span> starlette.responses <span class="hljs-keyword">import</span> PlainTextResponse<br><span class="hljs-keyword">from</span> starlette.requests <span class="hljs-keyword">import</span> Request<br><br><span class="hljs-keyword">async</span> <span class="hljs-keyword">def</span> <span class="hljs-title function_">app</span>(<span class="hljs-params">scope, receive, send</span>):<br>    event = <span class="hljs-keyword">await</span> receive()<br>    // ... do something<br>    <span class="hljs-keyword">assert</span> scope[<span class="hljs-string">&quot;type&quot;</span>] == <span class="hljs-string">&quot;http&quot;</span><br><br>	// Starlette includes a `Request` <span class="hljs-keyword">class</span> <span class="hljs-title class_">that</span> gives you a nicer interface onto the incoming<br>	//   request, rather than accessing the ASGI scope <span class="hljs-keyword">and</span> receive channel directly.<br>	request = Request(scope, receive)<br>	// ... do something <span class="hljs-keyword">with</span> request<br><br>    response = PlainTextResponse(<span class="hljs-string">&quot;Hello, world!&quot;</span>)<br>    <span class="hljs-keyword">await</span> response(scope, receive, send)<br></code></pre></td></tr></table></figure>
<h2 id="Frameworks-and-Tools"><a href="#Frameworks-and-Tools" class="headerlink" title="Frameworks and Tools"></a>Frameworks and Tools</h2><h3 id="poetry"><a href="#poetry" class="headerlink" title="poetry"></a>poetry</h3><p>2019 年接手的一个项目，最开始使用的是 pipenv 来进行项目管理，当时使用下来最大的问题是，它太慢了。在当时日常开发和部署体验都非常糟糕。当时去看它的文档的时候还注意到，它 18 年最好一次更新之后就一直停在那里了。在写这篇文章的时候再去看了下，我们当时注意到的最新的更新时间是 2018-11-26 然后再下一次更新就是 2020 年的 5 月。在此之前，我们所有的项目都全部替换掉了 pipenv。</p>
<p>当时我们的解决方法是，只使用最原始的 requirement 文件。对几个项目的一些共用的库，如 Flask &#x2F; schema &#x2F; requests 都统一版本。在部署的时候，所有的 Python 都用同一个 base docker image，里面已经预先 build 好了所有的共有的 pip packages。这样就能减少在部署的时候需要重新 install 一些 packages。但这个方案只能解决</p>
<p>一些 pipenv 问题的参考文章，和我当时的体验差不多</p>
<ul>
<li><a target="_blank" rel="noopener" href="https://greyli.com/do-not-use-pipenv/">https://greyli.com/do-not-use-pipenv/</a></li>
<li><a target="_blank" rel="noopener" href="https://zhuanlan.zhihu.com/p/80695813">https://zhuanlan.zhihu.com/p/80695813</a></li>
</ul>
<p>现在站在 2024 年的角度去看重新看这个问题的话，感觉已经有了更多更好的方案，如 poetry。当时 pipenv 有一个好处其实是能帮我们管理 env，后面去掉之后，开发者们就只能自己来用额外的 env 工具来开发了。</p>
<p>还有一点比较重要的是，poetry 的命令本身也将一些业界约定俗成的用法整合了进来。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_"># </span><span class="language-bash">build wheel package</span><br>poetry build<br><br>poetry new my-package<br>poetry new --src my-package<br></code></pre></td></tr></table></figure>

<p>上述代码中，new 可以加一个 <code>--src</code> 参数就可以在 src 目录下新建一个 my-package 的 package。</p>
<h3 id="Pydantic"><a href="#Pydantic" class="headerlink" title="Pydantic"></a>Pydantic</h3><p>最开始我们是用 <a target="_blank" rel="noopener" href="https://github.com/keleshev/schema">schema</a> 这个 library 去做 data validation。现在 type hint 语法出来之后，Pydantic 可以很好的完成这个工作。</p>
<blockquote>
<p>At the time of writing there are 214,100 repositories on GitHub and 8,119 packages on PyPI that depend on Pydantic.</p>
</blockquote>
<blockquote>
<p>Some notable libraries that depend on Pydantic:</p>
</blockquote>
<blockquote>
<ul>
<li><a target="_blank" rel="noopener" href="https://github.com/huggingface/transformers"><code>huggingface/transformers</code></a> 107,475 stars</li>
<li><a target="_blank" rel="noopener" href="https://github.com/tiangolo/fastapi"><code>tiangolo/fastapi</code></a> 60,355 stars</li>
<li><a target="_blank" rel="noopener" href="https://github.com/hwchase17/langchain"><code>hwchase17/langchain</code></a> 54,514 stars</li>
<li><a target="_blank" rel="noopener" href="https://github.com/apache/airflow"><code>apache/airflow</code></a> 30,955 stars</li>
</ul>
</blockquote>
<p>当时的选择其实也挺多的，如 <a target="_blank" rel="noopener" href="https://github.com/marshmallow-code/marshmallow">marshmallow</a> 和追求效率的 binary serialization format <a target="_blank" rel="noopener" href="https://github.com/msgpack/msgpack-python">msgpack</a>。现在这些 library 也还在更新，应该会很长一段时间会维持这两种不同风格的序列化方案。</p>
<h3 id="FastAPI"><a href="#FastAPI" class="headerlink" title="FastAPI"></a>FastAPI</h3><blockquote>
<p>FastAPI stands on the shoulders of giants:</p>
<ul>
<li><a target="_blank" rel="noopener" href="https://www.starlette.io/">Starlette</a> for the web parts.</li>
<li><a target="_blank" rel="noopener" href="https://pydantic-docs.helpmanual.io/">Pydantic</a> for the data parts.</li>
</ul>
</blockquote>
<p>3.6 版本的时代，感觉上是 Flask 和 Django 两个框架基本上是各取所需，前者更轻便，后者则是集成了很多东西。现在 fastapi 则是更好了。它可以很快的写出简单的样例</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> typing <span class="hljs-keyword">import</span> <span class="hljs-type">Union</span><br><br><span class="hljs-keyword">from</span> fastapi <span class="hljs-keyword">import</span> FastAPI<br><br>app = FastAPI()<br><br><span class="hljs-meta">@app.get(<span class="hljs-params"><span class="hljs-string">&quot;/&quot;</span></span>)</span><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">read_root</span>():<br>    <span class="hljs-keyword">return</span> &#123;<span class="hljs-string">&quot;Hello&quot;</span>: <span class="hljs-string">&quot;World&quot;</span>&#125;<br><br><span class="hljs-meta">@app.get(<span class="hljs-params"><span class="hljs-string">&quot;/items/&#123;item_id&#125;&quot;</span></span>)</span><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">read_item</span>(<span class="hljs-params">item_id: <span class="hljs-built_in">int</span>, q: <span class="hljs-type">Union</span>[<span class="hljs-built_in">str</span>, <span class="hljs-literal">None</span>] = <span class="hljs-literal">None</span></span>):<br>    <span class="hljs-keyword">return</span> &#123;<span class="hljs-string">&quot;item_id&quot;</span>: item_id, <span class="hljs-string">&quot;q&quot;</span>: q&#125;<br></code></pre></td></tr></table></figure>

<p>但通过 Pydantic 去定义 request &#x2F; reponse 的 schema，借助其自带的 Swagger &#x2F; ReDoc 支持，则可以直接生成对应 API 文档。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> typing <span class="hljs-keyword">import</span> <span class="hljs-type">Union</span><br><br><span class="hljs-keyword">from</span> fastapi <span class="hljs-keyword">import</span> FastAPI<br><span class="hljs-keyword">from</span> pydantic <span class="hljs-keyword">import</span> BaseModel<br><br>app = FastAPI()<br><br><span class="hljs-keyword">class</span> <span class="hljs-title class_">Item</span>(<span class="hljs-title class_ inherited__">BaseModel</span>):<br>    name: <span class="hljs-built_in">str</span><br>    price: <span class="hljs-built_in">float</span><br>    is_offer: <span class="hljs-type">Union</span>[<span class="hljs-built_in">bool</span>, <span class="hljs-literal">None</span>] = <span class="hljs-literal">None</span><br><br><span class="hljs-meta">@app.get(<span class="hljs-params"><span class="hljs-string">&quot;/&quot;</span></span>)</span><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">read_root</span>():<br>    <span class="hljs-keyword">return</span> &#123;<span class="hljs-string">&quot;Hello&quot;</span>: <span class="hljs-string">&quot;World&quot;</span>&#125;<br><br><span class="hljs-meta">@app.get(<span class="hljs-params"><span class="hljs-string">&quot;/items/&#123;item_id&#125;&quot;</span></span>)</span><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">read_item</span>(<span class="hljs-params">item_id: <span class="hljs-built_in">int</span>, q: <span class="hljs-type">Union</span>[<span class="hljs-built_in">str</span>, <span class="hljs-literal">None</span>] = <span class="hljs-literal">None</span></span>):<br>    <span class="hljs-keyword">return</span> &#123;<span class="hljs-string">&quot;item_id&quot;</span>: item_id, <span class="hljs-string">&quot;q&quot;</span>: q&#125;<br><br><span class="hljs-meta">@app.put(<span class="hljs-params"><span class="hljs-string">&quot;/items/&#123;item_id&#125;&quot;</span></span>)</span><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">update_item</span>(<span class="hljs-params">item_id: <span class="hljs-built_in">int</span>, item: Item</span>):<br>    <span class="hljs-keyword">return</span> &#123;<span class="hljs-string">&quot;item_name&quot;</span>: item.name, <span class="hljs-string">&quot;item_id&quot;</span>: item_id&#125;<br></code></pre></td></tr></table></figure>

<p>实际效果，如同前面介绍的，站在巨人的肩膀上。</p>
<h1 id="Conclusion"><a href="#Conclusion" class="headerlink" title="Conclusion"></a>Conclusion</h1><p>语言层面的变更还挺有趣的，感觉在保持 Python 语言有趣的情况下，又增加了许多严谨的特性。希望未来有更多机会用上这些新特性。</p>
<h1 id="References"><a href="#References" class="headerlink" title="References"></a>References</h1><ul>
<li><a target="_blank" rel="noopener" href="https://peps.python.org/pep-0492">https://peps.python.org/pep-0492</a></li>
<li><a target="_blank" rel="noopener" href="https://peps.python.org/pep-0526">https://peps.python.org/pep-0526</a></li>
<li><a target="_blank" rel="noopener" href="https://peps.python.org/pep-0557">https://peps.python.org/pep-0557</a></li>
<li><a target="_blank" rel="noopener" href="https://peps.python.org/pep-0636/">https://peps.python.org/pep-0636/</a></li>
<li><a target="_blank" rel="noopener" href="https://docs.python.org/3/library/dataclasses.html">https://docs.python.org/3/library/dataclasses.html</a></li>
<li><a target="_blank" rel="noopener" href="https://docs.python.org/3/library/stdtypes.html#typesmapping">https://docs.python.org/3/library/stdtypes.html#typesmapping</a></li>
</ul>

                
              </div>
            
            <hr/>
            <div>
              <div class="post-metas my-3">
  
  
    <div class="post-meta">
      <i class="iconfont icon-tags"></i>
      
        <a href="/tags/python/" class="print-no-link">#python</a>
      
    </div>
  
</div>


              
  

  <div class="license-box my-3">
    <div class="license-title">
      <div>Python Development At 2024</div>
      <div>http://yoursite.com/2024/03/24/python-development-at-2024/</div>
    </div>
    <div class="license-meta">
      
        <div class="license-meta-item">
          <div>Author</div>
          <div>Shing</div>
        </div>
      
      
        <div class="license-meta-item license-meta-date">
          <div>Posted on</div>
          <div>March 24, 2024</div>
        </div>
      
      
      
        <div class="license-meta-item">
          <div>Licensed under</div>
          <div>
            
              
              
                <a class="print-no-link" target="_blank" href="https://creativecommons.org/licenses/by/4.0/">
                  <span class="hint--top hint--rounded" aria-label="BY - Attribution">
                    <i class="iconfont icon-by"></i>
                  </span>
                </a>
              
            
          </div>
        </div>
      
    </div>
    <div class="license-icon iconfont"></div>
  </div>



              
                <div class="post-prevnext my-3">
                  <article class="post-prev col-6">
                    
                    
                  </article>
                  <article class="post-next col-6">
                    
                    
                      <a href="/2024/01/04/farewell-2023/" title="Farewell 2023">
                        <span class="hidden-mobile">Farewell 2023</span>
                        <span class="visible-mobile">Next</span>
                        <i class="iconfont icon-arrowright"></i>
                      </a>
                    
                  </article>
                </div>
              
            </div>

            
          </article>
        </div>
      </div>
    </div>

    <div class="side-col d-none d-lg-block col-lg-2">
      
  <aside class="sidebar" style="margin-left: -1rem">
    <div id="toc">
  <p class="toc-header">
    <i class="iconfont icon-list"></i>
    <span>Table of Contents</span>
  </p>
  <div class="toc-body" id="toc-body"></div>
</div>



  </aside>


    </div>
  </div>
</div>





  



  



  



  



  







    

    
      <a id="scroll-top-button" aria-label="TOP" href="#" role="button">
        <i class="iconfont icon-arrowup" aria-hidden="true"></i>
      </a>
    

    
      <div class="modal fade" id="modalSearch" tabindex="-1" role="dialog" aria-labelledby="ModalLabel"
     aria-hidden="true">
  <div class="modal-dialog modal-dialog-scrollable modal-lg" role="document">
    <div class="modal-content">
      <div class="modal-header text-center">
        <h4 class="modal-title w-100 font-weight-bold">Search</h4>
        <button type="button" id="local-search-close" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body mx-3">
        <div class="md-form mb-5">
          <input type="text" id="local-search-input" class="form-control validate">
          <label data-error="x" data-success="v" for="local-search-input">Keyword</label>
        </div>
        <div class="list-group" id="local-search-result"></div>
      </div>
    </div>
  </div>
</div>

    

    
  </main>

  <footer>
    <div class="footer-inner">
  
    <div class="footer-content">
       <a href="https://hexo.io" target="_blank" rel="nofollow noopener"><span>Hexo</span></a> <i class="iconfont icon-love"></i> <a href="https://github.com/fluid-dev/hexo-theme-fluid" target="_blank" rel="nofollow noopener"><span>Fluid</span></a> 
    </div>
  
  
  
  
</div>

  </footer>

  <!-- Scripts -->
  
  <script  src="https://lib.baomitu.com/nprogress/0.2.0/nprogress.min.js" ></script>
  <link  rel="stylesheet" href="https://lib.baomitu.com/nprogress/0.2.0/nprogress.min.css" />

  <script>
    NProgress.configure({"showSpinner":false,"trickleSpeed":100})
    NProgress.start()
    window.addEventListener('load', function() {
      NProgress.done();
    })
  </script>


<script  src="https://lib.baomitu.com/jquery/3.6.4/jquery.min.js" ></script>
<script  src="https://lib.baomitu.com/twitter-bootstrap/4.6.1/js/bootstrap.min.js" ></script>
<script  src="/js/events.js" ></script>
<script  src="/js/plugins.js" ></script>


  <script  src="https://lib.baomitu.com/typed.js/2.0.12/typed.min.js" ></script>
  <script>
    (function (window, document) {
      var typing = Fluid.plugins.typing;
      var subtitle = document.getElementById('subtitle');
      if (!subtitle || !typing) {
        return;
      }
      var text = subtitle.getAttribute('data-typed-text');
      
        typing(text);
      
    })(window, document);
  </script>




  
    <script  src="/js/img-lazyload.js" ></script>
  




  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/tocbot/4.20.1/tocbot.min.js', function() {
    var toc = jQuery('#toc');
    if (toc.length === 0 || !window.tocbot) { return; }
    var boardCtn = jQuery('#board-ctn');
    var boardTop = boardCtn.offset().top;

    window.tocbot.init(Object.assign({
      tocSelector     : '#toc-body',
      contentSelector : '.markdown-body',
      linkClass       : 'tocbot-link',
      activeLinkClass : 'tocbot-active-link',
      listClass       : 'tocbot-list',
      isCollapsedClass: 'tocbot-is-collapsed',
      collapsibleClass: 'tocbot-is-collapsible',
      scrollSmooth    : true,
      includeTitleTags: true,
      headingsOffset  : -boardTop,
    }, CONFIG.toc));
    if (toc.find('.toc-list-item').length > 0) {
      toc.css('visibility', 'visible');
    }

    Fluid.events.registerRefreshCallback(function() {
      if ('tocbot' in window) {
        tocbot.refresh();
        var toc = jQuery('#toc');
        if (toc.length === 0 || !tocbot) {
          return;
        }
        if (toc.find('.toc-list-item').length > 0) {
          toc.css('visibility', 'visible');
        }
      }
    });
  });
</script>


  <script src=https://lib.baomitu.com/clipboard.js/2.0.11/clipboard.min.js></script>

  <script>Fluid.plugins.codeWidget();</script>


  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/anchor-js/4.3.1/anchor.min.js', function() {
    window.anchors.options = {
      placement: CONFIG.anchorjs.placement,
      visible  : CONFIG.anchorjs.visible
    };
    if (CONFIG.anchorjs.icon) {
      window.anchors.options.icon = CONFIG.anchorjs.icon;
    }
    var el = (CONFIG.anchorjs.element || 'h1,h2,h3,h4,h5,h6').split(',');
    var res = [];
    for (var item of el) {
      res.push('.markdown-body > ' + item.trim());
    }
    if (CONFIG.anchorjs.placement === 'left') {
      window.anchors.options.class = 'anchorjs-link-left';
    }
    window.anchors.add(res.join(', '));

    Fluid.events.registerRefreshCallback(function() {
      if ('anchors' in window) {
        anchors.removeAll();
        var el = (CONFIG.anchorjs.element || 'h1,h2,h3,h4,h5,h6').split(',');
        var res = [];
        for (var item of el) {
          res.push('.markdown-body > ' + item.trim());
        }
        if (CONFIG.anchorjs.placement === 'left') {
          anchors.options.class = 'anchorjs-link-left';
        }
        anchors.add(res.join(', '));
      }
    });
  });
</script>


  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/fancybox/3.5.7/jquery.fancybox.min.js', function() {
    Fluid.plugins.fancyBox();
  });
</script>


  <script>Fluid.plugins.imageCaption();</script>

  <script  src="/js/local-search.js" ></script>





<!-- 主题的启动项，将它保持在最底部 -->
<!-- the boot of the theme, keep it at the bottom -->
<script  src="/js/boot.js" ></script>


  

  <noscript>
    <div class="noscript-warning">Blog works best with JavaScript enabled</div>
  </noscript>
</body>
</html>
