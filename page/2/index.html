<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  

  
  <title>Shing&#39;s logs</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta property="og:type" content="website">
<meta property="og:title" content="Shing&#39;s logs">
<meta property="og:url" content="http://yoursite.com/page/2/index.html">
<meta property="og:site_name" content="Shing&#39;s logs">
<meta property="og:locale" content="zh_CN">
<meta property="article:author" content="Shing">
<meta property="article:tag" content="golang, python">
<meta name="twitter:card" content="summary">
  
    <link rel="alternate" href="/atom.xml" title="Shing&#39;s logs" type="application/atom+xml">
  
  
    <link rel="icon" href="/favicon.png">
  
  
    <link href="//fonts.googleapis.com/css?family=Source+Code+Pro" rel="stylesheet" type="text/css">
  
  
<link rel="stylesheet" href="/css/style.css">

<meta name="generator" content="Hexo 5.4.0"></head>

<body>
  <div id="container">
    <div id="wrap">
      <header id="header">
  <div id="banner"></div>
  <div id="header-outer" class="outer">
    <div id="header-title" class="inner">
      <h1 id="logo-wrap">
        <a href="/" id="logo">Shing&#39;s logs</a>
      </h1>
      
    </div>
    <div id="header-inner" class="inner">
      <nav id="main-nav">
        <a id="main-nav-toggle" class="nav-icon"></a>
        
          <a class="main-nav-link" href="/">Home</a>
        
          <a class="main-nav-link" href="/archives">Archives</a>
        
      </nav>
      <nav id="sub-nav">
        
          <a id="nav-rss-link" class="nav-icon" href="/atom.xml" title="RSS Feed"></a>
        
        <a id="nav-search-btn" class="nav-icon" title="Search"></a>
      </nav>
      <div id="search-form-wrap">
        <form action="//google.com/search" method="get" accept-charset="UTF-8" class="search-form"><input type="search" name="q" class="search-form-input" placeholder="Search"><button type="submit" class="search-form-submit">&#xF002;</button><input type="hidden" name="sitesearch" value="http://yoursite.com"></form>
      </div>
    </div>
  </div>
</header>
      <div class="outer">
        <section id="main">
  
    <article id="post-k8s-introduction" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2018/12/01/k8s-introduction/" class="article-date">
  <time datetime="2018-11-30T16:00:00.000Z" itemprop="datePublished">2018-12-01</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2018/12/01/k8s-introduction/">k8s 简介</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>本文简单介绍下 k8s 的常用组件，知道其能为我们带来什么样的功能。</p>
<h2 id="Resources"><a href="#Resources" class="headerlink" title="Resources"></a>Resources</h2><h3 id="Cluster"><a href="#Cluster" class="headerlink" title="Cluster"></a>Cluster</h3><p>包含 Master 节点和众多的 Node 节点</p>
<h3 id="Master"><a href="#Master" class="headerlink" title="Master"></a>Master</h3><p>管理集群的节点，其上包含下列服务</p>
<p>kube-apiserver</p>
<ul>
<li>CLI 或者 UI</li>
</ul>
<p>kube-scheduler</p>
<ul>
<li>决定 Pod 放哪个 Node</li>
</ul>
<p>kube-controller-manager</p>
<ul>
<li>资源管理</li>
</ul>
<p>Node Controller</p>
<ul>
<li>Node go down 的时候进行处理</li>
</ul>
<p>Replication Controller</p>
<ul>
<li>保证 Pod 的数量是正确的</li>
</ul>
<p>Endpoints Controller</p>
<ul>
<li>连接 Service 和 Pods</li>
</ul>
<p>Service Account &amp; Token Controllers</p>
<ul>
<li>维护账号和用于 API 的 access token</li>
</ul>
<p>cloud-controller-manageretcd</p>
<ul>
<li>数据存储</li>
<li>alpha feature</li>
<li>与云服务商的服务打交道</li>
</ul>
<p>Pod 网络</p>
<ul>
<li>IP-per-Pod，每个 Pod 都拥有一个独立 IP 地址，Pod 内所有容器共享一个网络命名空间</li>
<li>集群内所有 Pod 都在一个直接连通的扁平网络中，可通过 IP 直接访问</li>
<li>所有容器之间无需 NAT 就可以直接互相访问</li>
<li>所有 Node 和所有容器之间无需 NAT 就可以直接互相访问</li>
<li>容器自己看到的 IP 跟其他容器看到的一样</li>
<li>Master 节点的 etcd 服务存放着各个 Node 的网络信息</li>
</ul>
<h3 id="Node"><a href="#Node" class="headerlink" title="Node"></a>Node</h3><p>集群中的节点，提供服务的节点，包含一个或多个 Pod</p>
<p>包含以下服务</p>
<ul>
<li>kubelet - 与 Master 通信</li>
<li>kube-proxy - 转发请求到 Pod</li>
<li>Pod 网络</li>
</ul>
<h3 id="Namespace"><a href="#Namespace" class="headerlink" title="Namespace"></a>Namespace</h3><ul>
<li>为物理的 cluster 提供虚拟 cluster 的隔离</li>
<li>如 test, production</li>
</ul>
<h3 id="Pod"><a href="#Pod" class="headerlink" title="Pod"></a>Pod</h3><ul>
<li>最小工作单位</li>
<li>同一个 Pod 中共享网络 namespace，即 localhost 可见各个容器的 port</li>
<li>一般是一个 image 一个 Pod</li>
</ul>
<h3 id="Controller"><a href="#Controller" class="headerlink" title="Controller"></a>Controller</h3><ul>
<li>用于控制 Pod 部署特性，如副本数量，部署的 Node</li>
<li>常见的 Controller<ul>
<li>Deployment</li>
<li>ReplicaSet - 供 Deployment 使用，管理 Pod 多个副本</li>
<li>DaemonSet - 每个 Node 最多一个 Pod，如 k8s 本身的管理进程</li>
<li>StatefulSet - 保持部署的名称不变</li>
<li>Job - Crontab</li>
</ul>
</li>
</ul>
<h3 id="Service"><a href="#Service" class="headerlink" title="Service"></a>Service</h3><p>为 Pod 提供负载均衡。一般来说，部署一个服务包含多个 Pod，而 Service 则是在其之上，他们间的关系如下</p>
<p>request -&gt; Service (-&gt; Deployment) -&gt; ReplicaSet -&gt; Pod</p>
<p>Service 是整合 Pod 的资源，作为其 LoadBalance，简单的例子如下：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">kind:</span> <span class="string">Service</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">my-service</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">nginx</span></span><br><span class="line">  <span class="attr">ports:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">protocol:</span> <span class="string">TCP</span></span><br><span class="line">      <span class="attr">port:</span> <span class="number">8080</span></span><br><span class="line">      <span class="attr">targetPort:</span> <span class="number">80</span></span><br></pre></td></tr></table></figure>

<p>上述 yml 则是将 Service 的 8080 端口映射到 app=nginx 的 Pod 中。因为 Pod 启动时是使用随机的 IP 的，这样子我们就可以通过指定 label 来选择相应的 Pod 了。</p>
<p>默认情况下，Service 的类型是 ClusterIP，即仅提供集群内部的服务，需要对外提供服务，则需要另外配置(spec.type 中定义)，即 NodePort 和 LoadBalancer 两种。</p>
<p>当配置为 NodePort 之后，集群的所有节点都监听一个 30000 以上的随机端口，将其收到的请求转发到 Service 中。此时，你就可以简单的在对应的机器上通过这个端口访问集群内部的 Service。</p>
<p>而 LoadBalancer 目前看则是像与云厂商相关的配置，根据具体厂商自己的负载均衡服务来调用我们定义的 Service。</p>
<h3 id="DNS"><a href="#DNS" class="headerlink" title="DNS"></a>DNS</h3><p>Pod 定义的服务可以通过 IP 和 Port 进行请求，而请求指定的 Service 则是通过 k8s 本身的 DNS 服务进行域名解析。</p>
<p>如一个 Service 名为 serv，其在 test 这个 namespace 下，则其在集群内可以通过 serv.test 来进行访问。而同一个 namespace 下则仅需要 serv 来进行请求。</p>
<h3 id="Ingress"><a href="#Ingress" class="headerlink" title="Ingress"></a>Ingress</h3><p>需要注意的 Ingress 目前还是 beta 的阶段，谨慎使用。</p>
<p>之前提及的 NodePort 也可以提供对外的服务，但是它是服务在 TCP 层上的，意味着其不能根据 path 或者 header 进行转发，而 Ingress 是工作在 HTTP 层。</p>
<p>request(not in cluster) -&gt; Ingress -&gt; Service (-&gt; Deployment) -&gt; ReplicaSet -&gt; Pod</p>
<p>Ingress 的使用需要两部分，Controller 和 Ingress。后者描述规则，前者实现规则。这里跟之前提及的 spec 和 status 概念有点类似。Controller 则是很多常见的做 proxy 的软件，如</p>
<ul>
<li>Nginx</li>
<li>Kong</li>
<li>HAProxy</li>
<li>…</li>
</ul>
<p>这里可以看一下简单的定义</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">extensions/v1beta1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Ingress</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">test-ingress</span></span><br><span class="line">  <span class="attr">annotations:</span></span><br><span class="line">    <span class="attr">nginx.ingress.kubernetes.io/rewrite-target:</span> <span class="string">/</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">rules:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">http:</span></span><br><span class="line">      <span class="attr">paths:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">path:</span> <span class="string">/testpath</span></span><br><span class="line">        <span class="attr">backend:</span></span><br><span class="line">          <span class="attr">serviceName:</span> <span class="string">test</span></span><br><span class="line">          <span class="attr">servicePort:</span> <span class="number">80</span></span><br></pre></td></tr></table></figure>

<p>Ingress 使用 annotation 来配置信息。而 spec 的信息一般包含以下内容</p>
<ul>
<li>可选的 host</li>
<li>一个或多个 path</li>
<li>host 和 path 所对应的 host</li>
</ul>
<p>就目前的信息而言，Controller 这块像一个单独部署的 Nginx Pod，然后监听相关 spec 的更新，然后修改自身的 config 去满足需求。</p>
<h2 id="In-detail"><a href="#In-detail" class="headerlink" title="In-detail"></a>In-detail</h2><h3 id="kubectl"><a href="#kubectl" class="headerlink" title="kubectl"></a>kubectl</h3><p>kubectl 用于管理 k8s 上的各种资源，常见的就是 kind=Deployment 用于部署服务。其一般用法如下</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&gt; kubectl apply -f xx.yml</span><br></pre></td></tr></table></figure>

<p>这里使用 yml 进行资源描述，而通过更新相应的 yml 文件，再次执行命令是则更新资源。实际上 k8s 是通过 REST API 对外提供服务，这里的 yml 则是实际上转化成 JSON 的格式发给 k8s Master 节点。</p>
<p>对于资源包含三部分信息</p>
<ul>
<li>ResourceSpec: 用户定义的理想状态</li>
<li>ResourceStatus: 当前执行的实际状态</li>
<li>Resource ObjectMeta: meta 信息，name, API Version, label 或者 annotation 等等，用户和 k8s 都能对其进行更新</li>
</ul>
<p>而我们定义的是 ResourceSpec 和 Resource ObjectMeta，而 k8s 尽量帮我们满足需求，其实际在系统中表示则是 ResourceStatus。</p>
<h3 id="Pod-1"><a href="#Pod-1" class="headerlink" title="Pod"></a>Pod</h3><p>容器只能在 Pod 中创建，这中间包含 Controllers: Deployment, Job, StatefulSet</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Pod</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">rss-site</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">nginx</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">containers:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">front-end</span></span><br><span class="line">      <span class="attr">image:</span> <span class="string">nginx</span></span><br><span class="line">      <span class="attr">ports:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">containerPort:</span> <span class="number">80</span></span><br></pre></td></tr></table></figure>

<p>此时新建的 Pod 则会由 k8s 随机分配一个 IP，无法控制，所以一般不会单独使用 Pod。</p>
<p>上述就是最简单的定义，一个 Pod 中包含一个 Nginx 容器，加一个 label app=nginx。Pod 可设置相应的检查，检查服务或者容器的状态。</p>
<ul>
<li>livenessProbe: 检查容器是否在运行，失败时会触发相应的 restartPolicy</li>
<li>readinessProbe: 检查容器能否服务，检查结果为 Success 时才相应地为 Service 服务</li>
</ul>
<p>这里对于 WEB/HTTP 服务，我们需要每个开发通用的 API，如 HTTP GET ping / pong 来表示统一的容器就绪状态。</p>
<p>这里有一种 initContainers 的配置用于容器启动时的前置条件。可用于执行诸如 Pod 注册的功能，其用法是启动一个新的容器，执行相应的命令。</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Pod</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">myapp-pod</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">myapp</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">containers:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">myapp-container</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">busybox</span></span><br><span class="line">    <span class="attr">command:</span> [<span class="string">&#x27;sh&#x27;</span>, <span class="string">&#x27;-c&#x27;</span>, <span class="string">&#x27;echo The app is running! &amp;&amp; sleep 3600&#x27;</span>]</span><br><span class="line">  <span class="attr">initContainers:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">init-myservice</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">busybox</span></span><br><span class="line">    <span class="attr">command:</span> [<span class="string">&#x27;sh&#x27;</span>, <span class="string">&#x27;-c&#x27;</span>, <span class="string">&#x27;until nslookup myservice; do echo waiting for myservice; sleep 2; done;&#x27;</span>]</span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">init-mydb</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">busybox</span></span><br><span class="line">    <span class="attr">command:</span> [<span class="string">&#x27;sh&#x27;</span>, <span class="string">&#x27;-c&#x27;</span>, <span class="string">&#x27;until nslookup mydb; do echo waiting for mydb; sleep 2; done;&#x27;</span>]</span><br></pre></td></tr></table></figure>

<p>除此以外，还有一种用于注入依赖的，如 volume，环境变量</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">settings.k8s.io/v1alpha1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">PodPreset</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">allow-database</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">matchLabels:</span></span><br><span class="line">      <span class="attr">role:</span> <span class="string">frontend</span></span><br><span class="line">  <span class="attr">env:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">DB_PORT</span></span><br><span class="line">      <span class="attr">value:</span> <span class="string">&quot;6379&quot;</span></span><br><span class="line">  <span class="attr">volumeMounts:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">mountPath:</span> <span class="string">/cache</span></span><br><span class="line">      <span class="attr">name:</span> <span class="string">cache-volume</span></span><br><span class="line">  <span class="attr">volumes:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">cache-volume</span></span><br><span class="line">      <span class="attr">emptyDir:</span> &#123;&#125;</span><br></pre></td></tr></table></figure>

<p>而别的容器使用的时候只需要符合对应的 label role=frontend 即可</p>
<p>需要注意的是，通过 API 去创建 Pod 之后，再去修改配置文件也不会对已有的 Pod 造成影响</p>
<blockquote>
<p>Subsequent changes to the template or even switching to a new template has no direct effect on the pods already created. Similarly, pods created by a replication controller may subsequently be updated directly.</p>
</blockquote>
<p>所以，也不推荐单独使用 Pod 这种资源，服务的管理应该使用更高层级的 Deployment 或者 StatefulSet 等等。</p>
<h3 id="Deployment"><a href="#Deployment" class="headerlink" title="Deployment"></a>Deployment</h3><p>Deployment 包含几种功能</p>
<ul>
<li>使用 ReplicaSet 去上线 Pod，并根据预设条件判断是否成功</li>
<li>更新 template 中 Pod 的状态，新的 ReplicaSet 会创建并转移旧的</li>
<li>回滚到旧的 Deployment 版本</li>
<li>通过设置副本数量扩容 / 减容</li>
</ul>
<p>这里关注几个常见的场景</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 根据配置创建 Deployment</span></span><br><span class="line">kubectl create -f app.yaml</span><br><span class="line"></span><br><span class="line"><span class="comment"># 查看 Deployment 信息</span></span><br><span class="line">kubectl get deployments.</span><br><span class="line"></span><br><span class="line"><span class="comment"># 查看指定 Deployment 的更新状态</span></span><br><span class="line">kubectl rollout status deployment.v1.apps/nginx-deployment</span><br><span class="line"></span><br><span class="line"><span class="comment"># 更新指定 Deployment 的镜像版本</span></span><br><span class="line"><span class="comment"># 后面 --record 选项需要添加，这样就可以在错误的升级之后回滚</span></span><br><span class="line">kubectl <span class="built_in">set</span> image deployment.v1.apps/nginx-deployment nginx=nginx:1.9.1 --record</span><br><span class="line"></span><br><span class="line"><span class="comment"># 查看 rollout 信息</span></span><br><span class="line">kubectl rollout <span class="built_in">history</span> deployment.v1.apps/nginx-deployment</span><br><span class="line"></span><br><span class="line"><span class="comment"># 查看指定版本的 rollout 信息，版本信息可以在上面的命令获取</span></span><br><span class="line">kubectl rollout <span class="built_in">history</span> deployment.v1.apps/nginx-deployment --revision=2</span><br><span class="line"></span><br><span class="line"><span class="comment"># 回滚到上一个版本</span></span><br><span class="line">kubectl rollout undo deployment.v1.apps/nginx-deployment</span><br><span class="line"></span><br><span class="line"><span class="comment"># 回滚到指定版本</span></span><br><span class="line">kubectl rollout undo deployment.v1.apps/nginx-deployment --to-revision=2</span><br><span class="line"></span><br><span class="line"><span class="comment"># 手动扩容</span></span><br><span class="line">kubectl scale deployment.v1.apps/nginx-deployment --replicas=10</span><br><span class="line"></span><br><span class="line"><span class="comment"># 根据条件自动扩容</span></span><br><span class="line">kubectl autoscale deployment.v1.apps/nginx-deployment --min=10 --max=15 --cpu-percent=80</span><br><span class="line"></span><br><span class="line"><span class="comment"># rolling update，作用于 Pods 和 ReplicationControllers，还是推荐使用 Deployment</span></span><br><span class="line">kubectl rolling-update frontend-v1 frontend-v2 --image=image:v2</span><br></pre></td></tr></table></figure>

<p>需要注意的是，Label selector 并不推荐更新，需要在部署的时候就提前规划好 label 的使用</p>
<blockquote>
<p>It is generally discouraged to make label selector updates and it is suggested to plan your selectors up front. In any case, if you need to perform a label selector update, exercise great caution and make sure you have grasped all of the implications.</p>
</blockquote>
<h4 id="ReplicaSet"><a href="#ReplicaSet" class="headerlink" title="ReplicaSet"></a>ReplicaSet</h4><p>docs: <a target="_blank" rel="noopener" href="https://kubernetes.io/docs/concepts/workloads/controllers/replicaset/">https://kubernetes.io/docs/concepts/workloads/controllers/replicaset/</a></p>
<p>ReplicaSet 是下一代的 Replication Controller，加多了 selector 的支持。官方更推荐使用 Deployment 来管理多个副本，而不用自己维护一个 ReplicaSet</p>
<blockquote>
<p> If you want the rolling update functionality please consider using Deployments instead.</p>
</blockquote>
<p>除了 rolling update 这个功能以外，看这个 <a target="_blank" rel="noopener" href="https://segmentfault.com/a/1190000016060606">文章</a> 似乎 ReplicaSet / Deployment 会影响到单独创建的符合条件的 Pod.</p>
<h4 id="Others"><a href="#Others" class="headerlink" title="Others"></a>Others</h4><p>除了最简单的 Deployment 以外，还包含其它资源类型：StatefulSet, DaemonSet, Job</p>
<blockquote>
<p>Note: StatefulSets are stable (GA) in 1.9.</p>
</blockquote>
<p>与 Deployment 不同，StatefulSet 用于部署有状态（磁盘）的应用。有着更为严格的扩容，更新机制，详见 <a target="_blank" rel="noopener" href="https://kubernetes.io/docs/concepts/workloads/controllers/statefulset/">文档</a>。</p>
<blockquote>
<p>A DaemonSet ensures that all (or some) Nodes run a copy of a Pod.</p>
</blockquote>
<p>DaemonSet 用于部署如日志收集，监控系统等服务。</p>
<p>Job 为分布式的 Crontab，可以指定 Pod 去执行任务。</p>
<h2 id="Conclusion"><a href="#Conclusion" class="headerlink" title="Conclusion"></a>Conclusion</h2><p>本文简介了 k8s 一些常用服务及其相关关系，而其底层实现（如其实现转发的 iptables 规则等等）则暂未涉及。</p>
<p>这里我们可以知道，k8s 本身仅仅做服务或者说 Pod 的管理，如果需要精确到流量（如 X% 的流量走这个版本，Y% 的流量走第二个版本）在 k8s 中则需要配置相应的 replicas 数量来实现。</p>
<p>而 Istio 或其它 ServiceMesh 插件或框架则提供了这类功能。</p>
<h2 id="References"><a href="#References" class="headerlink" title="References"></a>References</h2><ul>
<li><a target="_blank" rel="noopener" href="https://www.cnblogs.com/CloudMan6/p/8294766.html">5 分钟玩转 Docker 容器系列文章</a></li>
<li><a target="_blank" rel="noopener" href="https://www.cncf.io/wp-content/uploads/2018/03/CNCF-Presentation-Template-K8s-Deployment.pdf">k8s Deployment 生动的介绍</a></li>
<li><a target="_blank" rel="noopener" href="https://kubernetes.io/docs/reference/generated/kubernetes-api/v1.10/#-strong-api-overview-strong-">k8s API 文档</a></li>
<li><a target="_blank" rel="noopener" href="https://kubernetes.io/docs/tasks/configure-pod-container/configure-liveness-readiness-probes/">Pod 配置 Probe</a></li>
</ul>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://yoursite.com/2018/12/01/k8s-introduction/" data-id="ckv3iop6x001lesc87cwghde1" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/container/" rel="tag">container</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/k8s/" rel="tag">k8s</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/microservice/" rel="tag">microservice</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-use-python-mock" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2018/10/31/use-python-mock/" class="article-date">
  <time datetime="2018-10-30T16:00:00.000Z" itemprop="datePublished">2018-10-31</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2018/10/31/use-python-mock/">Python mock 的使用</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>以 ubuntu 18.04 上的 Python 3.6 为测试环境，Python 3.3 以前是需要额外安装 mock 库，现在是内置的标准库。</p>
<h2 id="Base"><a href="#Base" class="headerlink" title="Base"></a>Base</h2><p>mock 属于 unittest 的一部分，一般用于单元测试时去模拟调用外部系统的函数，类，如网络请求，操作系统的实时数据等等。下面是一个简单的例子</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">func</span>():</span></span><br><span class="line">    req = requests.get(<span class="string">&quot;http://www.baidu.com&quot;</span>)</span><br><span class="line">    <span class="keyword">return</span> req.content</span><br></pre></td></tr></table></figure>

<p>现在需要对上述代码进行测试，或者对依赖该模块的代码进行测试，需要对其网络请求进行模拟。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> unittest <span class="keyword">import</span> mock</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> core <span class="keyword">import</span> func</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">mock_requests_get</span>(<span class="params">s</span>):</span></span><br><span class="line">    <span class="class"><span class="keyword">class</span> <span class="title">Response</span>:</span></span><br><span class="line">        content = <span class="string">&quot;mock_requests_get&quot;</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> Response()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">MockResponse</span>:</span></span><br><span class="line">    content = <span class="string">&quot;mock_response&quot;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@mock.patch(<span class="params"><span class="string">&#x27;requests.get&#x27;</span>, mock_requests_get</span>)</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">mock_requests_with_decorator</span>():</span></span><br><span class="line">    <span class="built_in">print</span>(func())</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@mock.patch(<span class="params"><span class="string">&#x27;requests.get&#x27;</span></span>)</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">mock_requests_with_decorator_and_args</span>(<span class="params">mock_get</span>):</span></span><br><span class="line">    <span class="keyword">assert</span> mock_get == requests.get</span><br><span class="line">    <span class="built_in">print</span>(func()) <span class="comment"># &lt;MagicMock name=&#x27;get().content&#x27; id=&#x27;140081676909704&#x27;&gt;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&quot;__main__&quot;</span>:</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 1</span></span><br><span class="line">    <span class="keyword">with</span> mock.patch(<span class="string">&#x27;requests.get&#x27;</span>, mock_requests_get):</span><br><span class="line">        <span class="built_in">print</span>(func())</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 2</span></span><br><span class="line">    mock_requests_with_decorator()</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 3</span></span><br><span class="line">    mock_requests_with_decorator_and_args()</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 4</span></span><br><span class="line">    mock_get = mock.Mock(return_value=MockResponse())</span><br><span class="line">    requests.get = mock_get</span><br><span class="line">    <span class="built_in">print</span>(func())</span><br></pre></td></tr></table></figure>

<p>上述示例中的 1, 2 两种写法个人比较推崇，因为只会在使用到的时候才会去修改对应的代码。</p>
<p>除此以外还有挺多有意思的用法，如 <code>side_effect</code></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> unittest <span class="keyword">import</span> mock</span><br><span class="line"></span><br><span class="line">mock = mock.Mock()</span><br><span class="line"></span><br><span class="line">mock.side_effect = <span class="built_in">range</span>(<span class="number">1</span>, <span class="number">10</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">11</span>):</span><br><span class="line">    <span class="built_in">print</span>(mock()) <span class="comment"># 1, 2, 3, ..., 9</span></span><br><span class="line"><span class="comment"># raise exception when i == 10</span></span><br><span class="line"></span><br><span class="line">mock = mock.Mock()</span><br><span class="line">mock.side_effect = KeyError(<span class="string">&#x27;foo&#x27;</span>)</span><br><span class="line">mock()</span><br><span class="line"><span class="comment"># KeyError: &#x27;foo&#x27;</span></span><br></pre></td></tr></table></figure>

<p>与固定的 <code>return_value</code> 不同，<code>side_effect</code> 可以是一个可迭代对象，也可以是一个异常，相比于前者能更简单的模拟更多的情况。</p>
<h2 id="Mock"><a href="#Mock" class="headerlink" title="Mock"></a>Mock</h2><p>在最开始的代码中 <code>mock_requests_with_decorator_and_args</code> 用到了 Mock 类，但实际上没有指定具体的实现，却不妨碍代码继续执行。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> unittest <span class="keyword">import</span> mock</span><br><span class="line"></span><br><span class="line">mock = mock.Mock()</span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(mock)</span><br><span class="line"><span class="built_in">print</span>(mock.b) <span class="comment"># &lt;Mock name=&#x27;mock.b&#x27; id=&#x27;140415940033728&#x27;&gt;</span></span><br><span class="line"><span class="built_in">print</span>(mock.b.assert_called) <span class="comment">#</span></span><br></pre></td></tr></table></figure>

<p>Mock 是一个非常灵活的类，除了一些 magic method 和一些属性（见 <a target="_blank" rel="noopener" href="https://docs.python.org/3/library/unittest.mock.html#id3">这里</a> 的解释，解析器会对这些属性和方法的调用有额外的优化，不一定遵循规则）以外，调用一般的方法和属性都会自动生成一个出来。</p>
<p>查看代码 <code>/usr/lib/python3.6/unittest/mock.py</code> 可以看到，Mock 类是重写了 <code>__getattr__</code>，<code>__setattr__</code> 还有 <code>__call__</code> 一类 magic method 并且记录了调用次数，返回预定义的返回值 <code>return_value</code> 等等，可用于监控是否进行了调用。</p>
<h2 id="Patch"><a href="#Patch" class="headerlink" title="Patch"></a>Patch</h2><p>Patch 则是使用 Python 的上下文管理（Context Manager）的用法，重写了 <code>__enter__</code> 和 <code>__exit__</code>。同样在 <code>mock.py</code> 同一个代码文件中，可以参考下具体的写法。简单来说就是 <code>__enter__</code> 保存原有的 import，在 <code>__exit__</code> 的时候去掉 mock 的代码，将原有的 import 重新设置。</p>
<p>这里面涉及到很多的 <code>__getattr__</code>，<code>__setattr__</code> 和 <code>__import__</code> 的用法，有兴趣的话可以详细看下。</p>
<h2 id="References"><a href="#References" class="headerlink" title="References"></a>References</h2><ol>
<li><a target="_blank" rel="noopener" href="https://docs.python.org/3/library/unittest.mock.html#quick-guide">https://docs.python.org/3/library/unittest.mock.html#quick-guide</a></li>
</ol>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://yoursite.com/2018/10/31/use-python-mock/" data-id="ckv3iop6x001jesc8fi3r70yk" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/mock/" rel="tag">mock</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/patch/" rel="tag">patch</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/python/" rel="tag">python</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/unittest/" rel="tag">unittest</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-use-python-metaclass" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2018/09/15/use-python-metaclass/" class="article-date">
  <time datetime="2018-09-14T16:00:00.000Z" itemprop="datePublished">2018-09-15</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2018/09/15/use-python-metaclass/">Python metaclass 的使用</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>之前有个需求，需要去监控某些类的所有的函数调用的耗时，当时团队里面最开始的方案是通过继承某个基类来实现</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> functools</span><br><span class="line"><span class="keyword">import</span> types</span><br><span class="line"><span class="keyword">import</span> inspect</span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line"></span><br><span class="line">WRAPPER_ASSIGNMENTS = (<span class="string">&#x27;__module__&#x27;</span>, <span class="string">&#x27;__name__&#x27;</span>, <span class="string">&#x27;__doc__&#x27;</span>, <span class="string">&#x27;__self__&#x27;</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Timer</span>(<span class="params"><span class="built_in">object</span></span>):</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span>(<span class="params">self, key</span>):</span></span><br><span class="line">        self.key = key</span><br><span class="line">        self.ts = time.time()</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__enter__</span>(<span class="params">self</span>):</span></span><br><span class="line">        <span class="keyword">return</span> self</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__exit__</span>(<span class="params">self, *args</span>):</span></span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;---- &#123;&#125; consumes: &#123;&#125;&quot;</span>.<span class="built_in">format</span>(self.key, time.time() - self.ts))</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">MonitorBase</span>(<span class="params"><span class="built_in">object</span></span>):</span></span><br><span class="line">    <span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">    base interceptor for performance monitor system.</span></span><br><span class="line"><span class="string">    &#x27;&#x27;&#x27;</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__getattribute__</span>(<span class="params">self, attrname</span>):</span></span><br><span class="line"></span><br><span class="line">        <span class="comment"># 防止死循环</span></span><br><span class="line">        <span class="comment"># https://stackoverflow.com/questions/13538324/python-avoiding-infinite-loops-in-getattribute</span></span><br><span class="line">        attrvalue = <span class="built_in">super</span>(MonitorBase, self).__getattribute__(attrname)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> inspect.ismethod(attrvalue):</span><br><span class="line">            <span class="keyword">return</span> attrvalue</span><br><span class="line"></span><br><span class="line"><span class="meta">        @functools.wraps(<span class="params">attrvalue, WRAPPER_ASSIGNMENTS</span>)</span></span><br><span class="line">        <span class="function"><span class="keyword">def</span> <span class="title">warpFunc</span>(<span class="params">_self, *args, **kwargs</span>):</span></span><br><span class="line"></span><br><span class="line">            raise_ex = <span class="literal">None</span></span><br><span class="line">            key = <span class="string">&quot;&#123;&#125;.&#123;&#125;&quot;</span>.<span class="built_in">format</span>(self.__class__.__name__, attrname)</span><br><span class="line">            <span class="keyword">with</span> Timer(key):</span><br><span class="line">                result = <span class="literal">None</span></span><br><span class="line">                <span class="keyword">try</span>:</span><br><span class="line">                    result = attrvalue(*args, **kwargs)</span><br><span class="line">                <span class="keyword">except</span> Exception <span class="keyword">as</span> ex:</span><br><span class="line">                    raise_ex = ex</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> raise_ex <span class="keyword">is</span> <span class="keyword">not</span> <span class="literal">None</span>:</span><br><span class="line">                <span class="keyword">raise</span> raise_ex</span><br><span class="line">            <span class="keyword">return</span> result</span><br><span class="line"></span><br><span class="line">        <span class="comment"># https://stackoverflow.com/questions/37455426/advantages-of-using-methodtype-in-python</span></span><br><span class="line">        bound_method = types.MethodType(warpFunc, self, <span class="built_in">type</span>(self))</span><br><span class="line">        <span class="keyword">return</span> bound_method</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Worker</span>(<span class="params">MonitorBase</span>):</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">work</span>(<span class="params">self</span>):</span></span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;exec work&quot;</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">WorkerChild</span>(<span class="params">Worker</span>):</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">work</span>(<span class="params">self</span>):</span></span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;exec work&quot;</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">w = Worker()</span><br><span class="line">w.work()</span><br><span class="line"></span><br><span class="line">wc = WorkerChild()</span><br><span class="line">wc.work()</span><br></pre></td></tr></table></figure>

<p>这是团队里面一个人写的初始版本，十分的清晰易懂，通过改写 <code>___getattribute__</code> 方法，只对方法调用进行监控，对异常和返回值都原样处理。唯一的不同就是调用方法时使用 Timer 进行耗时计算。</p>
<p>这样子的写法的好处是，只要是基类继承了该监控类，后续的子类也会有相同的效果，但这里也衍生出另外的问题</p>
<ul>
<li>因为 <code>__getattribute__</code> 是实例方法，对类中的 staticmethod 和 classmethod 方法没有效果</li>
<li>每次调用都会重新把方法重新绑定到 self 中</li>
</ul>
<p>后续的讨论中主要是担心第二点会带来性能损耗。哪怕你对某些函数设置了标记位从而不去进行监控，因为你重写了这个 <code>__getattribute__</code> 方法，在实际使用上还是得去重新绑定到 self 上去。</p>
<h2 id="metaclass"><a href="#metaclass" class="headerlink" title="metaclass"></a>metaclass</h2><p>后面有人提出了元类的改进方案，具体代码如下</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> functools</span><br><span class="line"><span class="keyword">import</span> inspect</span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line"></span><br><span class="line">TIMED_METHOD_FLAG = <span class="string">&quot;__is_timed_method__&quot;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Timer</span>(<span class="params"><span class="built_in">object</span></span>):</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span>(<span class="params">self, key</span>):</span></span><br><span class="line">        self.key = key</span><br><span class="line">        self.ts = time.time()</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__enter__</span>(<span class="params">self</span>):</span></span><br><span class="line">        <span class="keyword">return</span> self</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__exit__</span>(<span class="params">self, exc_ty, exc_val, tb</span>):</span></span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;---- &#123;&#125; consumes: &#123;&#125;&quot;</span>.<span class="built_in">format</span>(self.key, time.time() - self.ts))</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">timed_wrapper</span>(<span class="params">f, stats_key</span>):</span></span><br><span class="line"><span class="meta">    @functools.wraps(<span class="params">f</span>)</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">wrapper</span>(<span class="params">*args, **kwargs</span>):</span></span><br><span class="line">        <span class="keyword">with</span> Timer(stats_key):</span><br><span class="line">            <span class="keyword">return</span> f(*args, **kwargs)</span><br><span class="line">    <span class="keyword">return</span> wrapper</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">MonitorMeta</span>(<span class="params"><span class="built_in">type</span></span>):</span></span><br><span class="line"></span><br><span class="line"><span class="meta">    @staticmethod</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">not_timed</span>(<span class="params">f</span>):</span></span><br><span class="line">        <span class="built_in">setattr</span>(f, TIMED_METHOD_FLAG, <span class="literal">False</span>)</span><br><span class="line">        <span class="keyword">return</span> f</span><br><span class="line"></span><br><span class="line"><span class="meta">    @staticmethod</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">is_timed_method</span>(<span class="params">f</span>):</span></span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">getattr</span>(f, TIMED_METHOD_FLAG, <span class="literal">True</span>)</span><br><span class="line"></span><br><span class="line"><span class="meta">    @staticmethod</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">need_to_timed</span>(<span class="params">fname, f</span>):</span></span><br><span class="line">        <span class="comment"># staticmethod or classmethod returns False</span></span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> inspect.isfunction(f):</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> MonitorMeta.is_timed_method(f):</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line"></span><br><span class="line">        <span class="comment"># is magic method</span></span><br><span class="line">        <span class="keyword">if</span> fname.startswith(<span class="string">&quot;__&quot;</span>) <span class="keyword">and</span> fname.endswith(<span class="string">&quot;__&quot;</span>):</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line">        <span class="keyword">return</span> <span class="literal">True</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span>(<span class="params">self, clsname, bases, attrs</span>):</span></span><br><span class="line">        <span class="built_in">super</span>(MonitorMeta, self).__init__(clsname, bases, attrs)</span><br><span class="line">        <span class="keyword">for</span> attrname, attrvalue <span class="keyword">in</span> attrs.items():</span><br><span class="line">            <span class="keyword">if</span> <span class="keyword">not</span> MonitorMeta.need_to_timed(attrname, attrvalue):</span><br><span class="line">                <span class="keyword">continue</span></span><br><span class="line">            <span class="built_in">setattr</span>(self, attrname, timed_wrapper(attrvalue, <span class="string">&quot;.&quot;</span>.join((clsname, attrname))))</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># class C(metaclass=MonitorMeta): # work at &gt;=python3.5</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">C</span>(<span class="params"><span class="built_in">object</span></span>):</span></span><br><span class="line"></span><br><span class="line">    __metaclass__ = MonitorMeta</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">haha</span>(<span class="params">self</span>):</span></span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;hah&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="meta">    @staticmethod</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">hehe</span>():</span></span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;asdads&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="meta">    @classmethod</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">heihei</span>(<span class="params">cls</span>):</span></span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;asdads&quot;</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">D</span>(<span class="params">C</span>):</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span>(<span class="params">self, hi</span>):</span></span><br><span class="line">        self.hi = hi</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">show</span>(<span class="params">self</span>):</span></span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;Hello world&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="meta">    @MonitorMeta.not_timed</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">work</span>(<span class="params">self</span>):</span></span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;work&quot;</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">d = D(<span class="number">123</span>)</span><br><span class="line">d.haha()</span><br><span class="line">d.show()</span><br><span class="line">d.work()</span><br></pre></td></tr></table></figure>

<p>这里涉及的改进是</p>
<ol>
<li>通过装饰器去设置标记位 <code>TIMED_METHOD_FLAG</code>，标记某些方法不进行收集，默认情况下除去一些 magic method 都进行收集</li>
<li>可以感知到 staticmethod 和 classmethod，但需要进一步的判断方法</li>
<li>只有需要收集的方法会有额外的操作，别的方法没有额外的操作</li>
</ol>
<p>但使用元类又有一个比较纠结的问题，在上述的例子中，C 使用了元类，D 继承 C，如果通过 D 的实例调用方法 <code>hah</code> 则实际上记录到的是 <code>C.hah</code>。</p>
<p>这里，我们希望知道的是具体的类对象的调用的时延，使用元类（之前的继承的方法没有这个问题）的话，可能会有一些这样造成困惑的数据。</p>
<h2 id="conclusion"><a href="#conclusion" class="headerlink" title="conclusion"></a>conclusion</h2><p>这是我第一次涉及到 Python 的元类相关的具体应用，最开始理解起来觉得比较绕，但实际上你记住 Python 里面一切皆对象就很容易理解了，类其实也是一种对象，我们可以通过元类去产生具体的类，由具体的类再产生对象</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">MyClass = MetaClass()</span><br><span class="line">my_object = MyClass()</span><br></pre></td></tr></table></figure>

<p>后续参考中的答案写得非常清晰，强烈推荐阅读。</p>
<h2 id="references"><a href="#references" class="headerlink" title="references"></a>references</h2><ol>
<li><a target="_blank" rel="noopener" href="https://stackoverflow.com/questions/100003/what-are-metaclasses-in-python">https://stackoverflow.com/questions/100003/what-are-metaclasses-in-python</a></li>
</ol>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://yoursite.com/2018/09/15/use-python-metaclass/" data-id="ckv3iop6v001hesc86r9x9lii" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/metaclass/" rel="tag">metaclass</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/python/" rel="tag">python</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-get-started-in-java-03" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2018/08/27/get-started-in-java-03/" class="article-date">
  <time datetime="2018-08-26T16:00:00.000Z" itemprop="datePublished">2018-08-27</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2018/08/27/get-started-in-java-03/">Java 学习记录 03</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>环境：Java8, Idea 社区版，ubuntu 18.04 LTS</p>
<p>背景：基本没有 Java 实战经验，有 Python 和 Golang 的经验</p>
<p>前篇</p>
<ul>
<li>学习记录 <a href="/2018/07/13/get-started-in-java-01/">01</a></li>
<li>学习记录 <a href="/2018/07/27/get-started-in-java-02/">02</a></li>
</ul>
<h2 id="Thread"><a href="#Thread" class="headerlink" title="Thread"></a>Thread</h2><h3 id="Thread-Object"><a href="#Thread-Object" class="headerlink" title="Thread-Object"></a>Thread-Object</h3><p>如果需要初始化一个 Thread 对象，则有两种办法</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">HelloRunnable</span> <span class="keyword">implements</span> <span class="title">Runnable</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;Hello from a thread!&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String args[])</span> </span>&#123;</span><br><span class="line">        (<span class="keyword">new</span> Thread(<span class="keyword">new</span> HelloRunnable())).start();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">HelloThread</span> <span class="keyword">extends</span> <span class="title">Thread</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;Hello from a thread!&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String args[])</span> </span>&#123;</span><br><span class="line">        (<span class="keyword">new</span> HelloThread()).start();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>上述两种方法在这里是等价的，run 方法实现具体的线程的功能，通过 start 方法去启动线程。具体的选择看具体的要求，一个是实现接口，一个是继承，推荐使用前者。</p>
<h3 id="Thread-Management"><a href="#Thread-Management" class="headerlink" title="Thread-Management"></a>Thread-Management</h3><p>你看 Thread 相关实现会发现，一些用于暂停，关闭线程的方法都被废弃了。像 Thread.stop 方法，会直接关掉线程，导致没办法去执行一些资源释放的操作，容易造成不一致的情况。所以最好的情况是通知线程，让线程自己处理。</p>
<p>相关方法为</p>
<ul>
<li>public void Thread.interrupt()</li>
<li>public boolean isInterrupted()</li>
<li>public static boolean interrupted()</li>
</ul>
<p><code>isInterrupted</code> 方法和 <code>interrupted</code> 方法实际上有些不同</p>
<ul>
<li><code>isInterrupted</code> 方法仅仅检查是否处于中断状态</li>
<li><code>interrupted</code> 方法读取中断状态并清除，即设为 false</li>
</ul>
<p><code>interrupted</code> 方法可以理解为，当前的请求中断的需求已经知悉，而是否进行处理则是当前线程的责任了。<code>interrupt</code> 方法做的仅仅是将线程内的标志位设为 true。</p>
<p>除此以外，如果线程正在处于阻塞状态（Thread.sleep, join …）时，则会抛出 <code>InterruptedException</code> 异常，这个异常需要注意下</p>
<ul>
<li>当抛出异常，调用 <code>isInterrupted</code> 方法，此时处于 false 状态</li>
<li>如果捕获该异常，则应重置该状态，即 <code>Thread.currentThread().interrupt()</code></li>
</ul>
<p>可见示例代码</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">    Thread t = <span class="keyword">new</span> Thread() &#123;</span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                Thread.sleep(<span class="number">1000</span>);</span><br><span class="line">            &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">                System.out.println(Thread.currentThread().isInterrupted()); <span class="comment">// false</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;;</span><br><span class="line">    t.start();</span><br><span class="line">    t.interrupt();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        Thread.sleep(<span class="number">1000</span>);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="Synchronization"><a href="#Synchronization" class="headerlink" title="Synchronization"></a>Synchronization</h2><h3 id="happens-before"><a href="#happens-before" class="headerlink" title="happens-before"></a>happens-before</h3><ul>
<li>Thread.start 方法调用前的代码 happens-before 线程的创建，相应的修改对新线程可见</li>
<li>一个线程结束后，则会导致 Thread.join 返回，所有该线程结束前的代码 happens-before join 方法调用，该线程的操作对调用 join 的线程可见</li>
</ul>
<h3 id="synchronized"><a href="#synchronized" class="headerlink" title="synchronized"></a>synchronized</h3><p>synchronized methods</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SynchronizedCounter</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> c = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">synchronized</span> <span class="keyword">void</span> <span class="title">increment</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        c++;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">synchronized</span> <span class="keyword">void</span> <span class="title">decrement</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        c--;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">synchronized</span> <span class="keyword">int</span> <span class="title">value</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> c;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 也可以写成如下方式</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">SynchronizedCounter</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> c = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">increment</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">synchronized</span> (<span class="keyword">this</span>) &#123;</span><br><span class="line">            c++;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">decrement</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">synchronized</span> (<span class="keyword">this</span>) &#123;</span><br><span class="line">            c--;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">value</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">synchronized</span> (<span class="keyword">this</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> c;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 可以明确指定锁来分离不同的需要加锁的逻辑</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MsLunch</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">long</span> c1 = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">long</span> c2 = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">private</span> Object lock1 = <span class="keyword">new</span> Object();</span><br><span class="line">    <span class="keyword">private</span> Object lock2 = <span class="keyword">new</span> Object();</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">inc1</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">synchronized</span>(lock1) &#123;</span><br><span class="line">            c1++;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">inc2</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">synchronized</span>(lock2) &#123;</span><br><span class="line">            c2++;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>同步方法有下面的特点</p>
<ul>
<li>不同的线程对同一个对象的同步方法调用不会交叉，即一个调用时另一个会 block 然后等前一个调用完成</li>
<li>前一个调用 happens-before 后面别的同步方法的调用，保证改动对所有线程可见</li>
<li>构造函数不能（也没意义）添加 synchronized 关键字</li>
</ul>
<p>这样就保证了不同线程调用同一个对象时，读、写数据不会造成不一致的情况。</p>
<h3 id="locks"><a href="#locks" class="headerlink" title="locks"></a>locks</h3><p>内在锁（intrinsic lock）或称为监视器锁（monitor lock），用于建立不同线程间调用时 happens-before 的关系。</p>
<p>具体的定义为</p>
<blockquote>
<p>Every object has an intrinsic lock associated with it. By convention, a thread that needs exclusive and consistent access to an object’s fields has to acquire the object’s intrinsic lock before accessing them, and then release the intrinsic lock when it’s done with them. A thread is said to own the intrinsic lock between the time it has acquired the lock and released the lock. As long as a thread owns an intrinsic lock, no other thread can acquire the same lock. The other thread will block when it attempts to acquire the lock.</p>
</blockquote>
<blockquote>
<p>When a thread releases an intrinsic lock, a happens-before relationship is established between that action and any subsequent acquisition of the same lock.</p>
</blockquote>
<p>当一个线程执行 synchronized 相关方法时，则申请一个内在锁，等到退出（哪怕是未捕捉的异常退出）时释放锁，别的线程才可继续调用该对象的 synchronized 方法。synchronized 为可重入锁，即同一个线程内的可以直接调用其它 synchronized 修饰的方法。</p>
<h3 id="atomic-access"><a href="#atomic-access" class="headerlink" title="atomic-access"></a>atomic-access</h3><ul>
<li>Reads and writes are atomic for reference variables and for most primitive variables (all types except long and double).</li>
<li>Reads and writes are atomic for all variables declared volatile (including long and double variables).</li>
</ul>
<p>关于 long 和 double 类型的读写不是原子性，可见后面的参考文章。即对 long 和 double 类型的读写最好放在 synchronized 中进行。</p>
<h3 id="guarded-block"><a href="#guarded-block" class="headerlink" title="guarded-block"></a>guarded-block</h3><p>即在线程中循环检查某个条件，条件满足之后才进行后续的行为。比较推荐的做法是，检查该条件，并且调用 wait 方法</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">synchronized</span> <span class="keyword">void</span> <span class="title">guardedJoy</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="comment">// This guard only loops once for each special event, which may not</span></span><br><span class="line">    <span class="comment">// be the event we&#x27;re waiting for.</span></span><br><span class="line">    <span class="keyword">while</span>(!joy) &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            wait();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;&#125;</span><br><span class="line">    &#125;</span><br><span class="line">    System.out.println(<span class="string">&quot;Joy and efficiency have been achieved!&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 另一个方法调用 notifyAll() 方法去通知等待锁释放的线程</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">synchronized</span> <span class="title">notifyJoy</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    joy = <span class="keyword">true</span>;</span><br><span class="line">    notifyAll();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这里需要注意的是，该处的 wait 方法属于 Object 的方法，只能在 synchronized 修饰的方法中使用。除了 notifyAll 以外，还有个 notify 方法，该方法则是随机唤醒一个在等待锁释放的线程，平时更倾向于使用 notifyAll。</p>
<h2 id="Immutable-Objects"><a href="#Immutable-Objects" class="headerlink" title="Immutable Objects"></a>Immutable Objects</h2><p>不可变对象，即对象本身的状态（字段）不会更新（不能更新），具体的策略如下</p>
<ul>
<li>如果需要修改对象属性，可通过方法新建一个对象，原有的对象不变</li>
<li>所有的字段都已经是私有的，加上 final</li>
<li>将类声明为 final 的，子类服务重写其方法，也可以通过将构造函数声明为 private，通过工厂方法创建对象</li>
<li>只有一个字段是对象引用，并且被引用的对象也是不可变对象</li>
</ul>
<h2 id="High-Level-Concurrency-Objects"><a href="#High-Level-Concurrency-Objects" class="headerlink" title="High Level Concurrency Objects"></a>High Level Concurrency Objects</h2><h3 id="Lock-Objects"><a href="#Lock-Objects" class="headerlink" title="Lock-Objects"></a>Lock-Objects</h3><p>Lock 类比之前的 synchronized 提供更加细致的方法，如支持 wait / notify 方法，支持 tryLock 可以用于获取锁的超时控制。</p>
<h3 id="Concurrent-Collections"><a href="#Concurrent-Collections" class="headerlink" title="Concurrent-Collections"></a>Concurrent-Collections</h3><ul>
<li>BlockingQueue - FIFO 如果队列满了 / 空了阻塞相应的请求</li>
<li>ConcurrentMap - 对 KV 的操作加锁</li>
</ul>
<h3 id="Atomic-Variables"><a href="#Atomic-Variables" class="headerlink" title="Atomic-Variables"></a>Atomic-Variables</h3><p>如 <code>java.util.concurrent.atomic.AtomicInteger</code> 对其进行增减操作不需要进行额外的加锁，其内部进行锁的相关操作。</p>
<p>相比 synchronized 修饰的代码，这边能更精确的控制临界区，减少不必要的同步操作。</p>
<h2 id="References"><a href="#References" class="headerlink" title="References"></a>References</h2><ol>
<li><a target="_blank" rel="noopener" href="https://docs.oracle.com/javase/tutorial/essential/concurrency/index.html">官方教程</a></li>
<li><a target="_blank" rel="noopener" href="https://docs.oracle.com/javase/7/docs/technotes/guides/concurrency/threadPrimitiveDeprecation.html">Why are Thread.stop, Thread.suspend and Thread.resume Deprecated?</a></li>
<li><a target="_blank" rel="noopener" href="https://dzone.com/articles/longdouble-are-not-atomic-in-java">Long and Double Values Are Not Atomic in Java</a></li>
<li><a target="_blank" rel="noopener" href="https://stackoverflow.com/questions/6155951/whats-the-difference-between-deadlock-and-livelock">死锁和活锁的区别</a></li>
<li><a target="_blank" rel="noopener" href="https://docs.oracle.com/javase/tutorial/essential/concurrency/newlocks.html">Lock Objects</a></li>
</ol>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://yoursite.com/2018/08/27/get-started-in-java-03/" data-id="ckv3iop6v001fesc888ct7b5u" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/concurrency/" rel="tag">concurrency</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/java/" rel="tag">java</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/thread/" rel="tag">thread</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-get-started-in-java-02" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2018/07/27/get-started-in-java-02/" class="article-date">
  <time datetime="2018-07-26T16:00:00.000Z" itemprop="datePublished">2018-07-27</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2018/07/27/get-started-in-java-02/">Java 学习记录 02</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>环境：Java8, Idea 社区版，ubuntu 18.04 LTS</p>
<p>背景：基本没有 Java 实战经验，有 Python 和 Golang 的经验</p>
<p>前篇</p>
<ul>
<li>学习记录 <a href="/2018/07/13/get-started-in-java-01/">01</a></li>
</ul>
<h2 id="Basic-Data-Type"><a href="#Basic-Data-Type" class="headerlink" title="Basic-Data-Type"></a>Basic-Data-Type</h2><p>常见类型有</p>
<ul>
<li>byte (8)</li>
<li>short (16)</li>
<li>int (32)</li>
<li>long (64)</li>
<li>float (32)</li>
<li>double (64)</li>
<li>boolean</li>
<li>char (16)</li>
</ul>
<p>需要注意的是，局部变量声明后需要进行初始化，否则将报错。但作为类的成员则有默认值，如 int 不初始化则默认为 0。</p>
<h3 id="Encoding"><a href="#Encoding" class="headerlink" title="Encoding"></a>Encoding</h3><p>我在本机环境下进行测试时，JVM 默认的编码为 UTF-8。如果对编码比较敏感，可以通过设置环境变量修改编码，这里有个有趣的例子</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">    SecureRandom random = <span class="keyword">new</span> SecureRandom();</span><br><span class="line">    <span class="keyword">byte</span>[] src = <span class="keyword">new</span> <span class="keyword">byte</span>[<span class="number">16</span>];</span><br><span class="line">    random.nextBytes(src);</span><br><span class="line"></span><br><span class="line">    System.out.println(src.length);</span><br><span class="line"></span><br><span class="line">    String dst = <span class="keyword">new</span> String(src);</span><br><span class="line">    System.out.println(dst.length());</span><br><span class="line">    System.out.println(dst.getBytes().length);</span><br><span class="line">    System.out.println(dst.getBytes(StandardCharsets.UTF_16).length);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>上述的结果除了第一个是明确的 16 以外其它都是不明确的，对于一个 byte，UTF-8 可能会以 2 个 byte 编码，所以上述代码的 dst 则是不确定长度的。但一般来说这种场景比较少见，在实际写代码的过程中，我们使用的是编码过后的文件或者输入，而不是直接处理 unicode。</p>
<h2 id="Array"><a href="#Array" class="headerlink" title="Array"></a>Array</h2><p>Array 为定长的固定类型的数组。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 声明但不初始化使用则会报错，variable X might not have been initialized</span></span><br><span class="line"><span class="keyword">int</span>[] array;</span><br><span class="line"></span><br><span class="line">array = <span class="keyword">new</span> <span class="keyword">int</span>[<span class="number">1</span>];</span><br><span class="line"></span><br><span class="line"><span class="comment">// 如果不赋值，array[0] 为对应类型的默认值，这里为 0</span></span><br><span class="line">array[<span class="number">0</span>] = <span class="number">1</span>;</span><br><span class="line">System.out.println(array);</span><br><span class="line"></span><br><span class="line"><span class="comment">// array = &#123;1&#125;;</span></span><br><span class="line"><span class="comment">// 不能重新初始化</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">int</span>[] list = &#123;<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>&#125;;</span><br><span class="line">System.out.println(list);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 二维数组</span></span><br><span class="line">String[][] names = &#123;</span><br><span class="line">    &#123;<span class="string">&quot;Mr. &quot;</span>, <span class="string">&quot;Mrs. &quot;</span>, <span class="string">&quot;Ms. &quot;</span>&#125;,</span><br><span class="line">    &#123;<span class="string">&quot;Smith&quot;</span>, <span class="string">&quot;Jones&quot;</span>&#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>在 <code>java.util.Arrays</code> 中包含众多 array 的有用的方法</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">int</span>[] src = &#123;<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>, <span class="number">5</span>, <span class="number">6</span>, <span class="number">7</span>&#125;;</span><br><span class="line"><span class="keyword">int</span>[] dst = Arrays.copyOfRange(src, <span class="number">0</span>, <span class="number">5</span>); <span class="comment">// copy</span></span><br><span class="line">Arrays.sort(dst); <span class="comment">// sort</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> (<span class="keyword">int</span> item: dst) &#123;</span><br><span class="line">    System.out.println(item);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">System.out.println(Arrays.binarySearch(src, <span class="number">8</span>)); <span class="comment">// binarySearch</span></span><br></pre></td></tr></table></figure>

<h2 id="Nested-Classes"><a href="#Nested-Classes" class="headerlink" title="Nested-Classes"></a>Nested-Classes</h2><p>嵌套类分两种，static 的和 non-static 的。前者为静态嵌套类，后者为内部类。</p>
<h3 id="Static-Nested-Classes"><a href="#Static-Nested-Classes" class="headerlink" title="Static-Nested-Classes"></a>Static-Nested-Classes</h3><p>静态嵌套类（下称嵌套类）为包含其的类（这里称为外部类）的一个成员。</p>
<p>嵌套类能访问外部类的 static 属性（包括 private）和方法，即与该类关联，而不是与该类的实例管理。常用来实现外部类相关的一些 helper 方法。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">OuterClass</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">int</span> objCnt = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">StaticNestedClass</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">getObjCnt</span><span class="params">()</span> </span>&#123;</span><br><span class="line">            <span class="keyword">return</span> objCnt;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">OuterClass</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        objCnt +=<span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// OuterClass.StaticNestedClass snc = new OuterClass.StaticNestedClass();</span></span><br><span class="line"><span class="comment">// System.out.println(snc.getObjCnt());</span></span><br></pre></td></tr></table></figure>

<h3 id="Inner-Classes"><a href="#Inner-Classes" class="headerlink" title="Inner-Classes"></a>Inner-Classes</h3><p>内部类的实例与外部类的实例绑定，与嵌套类不同的是，内部类不允许有 static 的成员。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">OuterClass</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">int</span> v = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">int</span> x = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">InnerClass</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">int</span> v = <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">testPrint</span><span class="params">()</span> </span>&#123;</span><br><span class="line">            System.out.println(<span class="string">&quot;this.v = &quot;</span> + v);</span><br><span class="line">            System.out.println(<span class="string">&quot;this.v = &quot;</span> + <span class="keyword">this</span>.v);</span><br><span class="line">            System.out.println(<span class="string">&quot;OuterClass.this.x = &quot;</span> + x);</span><br><span class="line">            System.out.println(<span class="string">&quot;OuterClass.this.v = &quot;</span> + OuterClass.<span class="keyword">this</span>.v);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// OuterClass.InnerClass ic = oc.new InnerClass();</span></span><br><span class="line"><span class="comment">// ic.testPrint();</span></span><br><span class="line"><span class="comment">// -&gt; this.v = 1</span></span><br><span class="line"><span class="comment">// -&gt; this.v = 1</span></span><br><span class="line"><span class="comment">// -&gt; OuterClass.this.x = 0</span></span><br><span class="line"><span class="comment">// -&gt; OuterClass.this.v = 0</span></span><br></pre></td></tr></table></figure>

<p>上述 this 的用法与之前说过的类似，用于指明访问的是哪一个变量。如果内部类定义了与外部类同名的成员，则直接使用会屏蔽外部类对应的成员。</p>
<h3 id="Local-Classes"><a href="#Local-Classes" class="headerlink" title="Local-Classes"></a>Local-Classes</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Main</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">        String word = <span class="string">&quot;word&quot;</span>;</span><br><span class="line">        <span class="comment">// word = &quot;helloworld&quot;;</span></span><br><span class="line">        <span class="comment">// 去掉注释则会报错</span></span><br><span class="line"></span><br><span class="line">        <span class="class"><span class="keyword">class</span> <span class="title">Test</span> </span>&#123;</span><br><span class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">print</span><span class="params">()</span> </span>&#123;</span><br><span class="line">                System.out.println(word);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        Test t = <span class="keyword">new</span> Test();</span><br><span class="line">        t.print();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>本地类用于用完即弃的场景。</p>
<p>需要注意的是，在本地类中可以访问外部的局部变量，前提是这些变量是 final 的或者是 effectively final。effectively final 为 Java8 新增的特性，即变量初始化时编译器都当作 final，但在更新时变成了 non-final。</p>
<p>同样的，如果本地类中定义了同名的成员，则会屏蔽外部的变量。</p>
<h3 id="Anonymous-Classes"><a href="#Anonymous-Classes" class="headerlink" title="Anonymous-Classes"></a>Anonymous-Classes</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Main</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="class"><span class="keyword">interface</span> <span class="title">Greeter</span> </span>&#123;</span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">sayHi</span><span class="params">()</span></span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">        Greeter helloWorld = <span class="keyword">new</span> Greeter() &#123;</span><br><span class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">sayHi</span><span class="params">()</span> </span>&#123;</span><br><span class="line">                System.out.println(<span class="string">&quot;hello-world&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;;</span><br><span class="line"></span><br><span class="line">        helloWorld.sayHi();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>同内部类和本地类，匿名类都不能有 static 属性 / 方法，但是可以有 <code>final static</code> 的属性。匿名类的常见例子如实现自定义排序的规则。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">Integer[] ls = &#123;<span class="number">1</span>, <span class="number">4</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">0</span>&#125;;</span><br><span class="line"></span><br><span class="line">Arrays.sort(ls, <span class="keyword">new</span> Comparator&lt;Integer&gt;() &#123;</span><br><span class="line">    <span class="meta">@Override</span> <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">compare</span><span class="params">(Integer x, Integer y)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> x - y; <span class="comment">// 升序排列</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<h2 id="Lambda"><a href="#Lambda" class="headerlink" title="Lambda"></a>Lambda</h2><p>上述的排序可以以 Lambda 表达式改写</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Arrays.sort(ls, (x, y) -&gt; x - y);</span><br></pre></td></tr></table></figure>

<p>Lambda 表达式基本语法如下</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">(arg1, arg2...) -&gt; &#123; body &#125;</span><br><span class="line"></span><br><span class="line">(type1 arg1, type2 arg2...) -&gt; &#123; body &#125;</span><br><span class="line"></span><br><span class="line">() -&gt; &#123; body &#125;</span><br></pre></td></tr></table></figure>

<p>这里还有另一个常见的例子，用于过滤数组</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> java.util.Arrays;</span><br><span class="line"><span class="keyword">import</span> java.util.List;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">interface</span> <span class="title">Predicate</span>&lt;<span class="title">T</span>&gt; </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">boolean</span> <span class="title">test</span><span class="params">(T t)</span></span>;</span><br><span class="line">    <span class="comment">// 用于 Lambda 的 interface 只能有一个方法</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Main</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        List&lt;Integer&gt; list = Arrays.asList(<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>, <span class="number">5</span>, <span class="number">6</span>, <span class="number">7</span>);</span><br><span class="line"></span><br><span class="line">        evaluate(list, x -&gt; x &gt; <span class="number">1</span>);</span><br><span class="line">        evaluate(list, x -&gt; <span class="keyword">true</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 将标准库原有的函数转化为 Lambda 表达式</span></span><br><span class="line">        list.forEach(System.out::println);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">evaluate</span><span class="params">(List&lt;Integer&gt; list, Predicate&lt;Integer&gt; predicate)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">for</span> (Integer n : list) &#123;</span><br><span class="line">            <span class="keyword">if</span> (predicate.test(n)) &#123;</span><br><span class="line">                System.out.print(n + <span class="string">&quot; &quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        System.out.println();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>


<p>基本的规则如下</p>
<ul>
<li>可带参数，也可不带参数</li>
<li>可带类型，也可不带类型，根据上下文来推导类型</li>
</ul>
<p>Lambda 更多与 Interface 细节相关，这里先只介绍相关语法。</p>
<h2 id="Annotation"><a href="#Annotation" class="headerlink" title="Annotation"></a>Annotation</h2><p>注解，对被注解代码的逻辑没有直接的影响，而是在逻辑以外提供额外的数据信息。</p>
<ul>
<li>可提供信息给编译器使用</li>
<li>IDE 可根据注解生成对应的配置文件</li>
<li>其信息可被编译进 class 文件中，或者说保留在 Java 虚拟机中，供运行时判断</li>
</ul>
<p>对于 Java 代码从编写到运行有三个时期</p>
<ol>
<li>代码编辑</li>
<li>编译成 .class 文件</li>
<li>读取到 JVM 运行</li>
</ol>
<p>针对这三个时期有三种 Annotation 对应</p>
<ol>
<li>RetentionPolicy.SOURCE  // 只在代码编辑期生效</li>
<li>RetentionPolicy.CLASS   // 在编译期生效，默认值</li>
<li>RetentionPolicy.RUNTIME // 在代码运行时生效</li>
</ol>
<p>除此之外，Java 提供了 @Target 这个 元注解 来指定某个 Annotation 修饰的目标对象，如</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Target(&#123;TYPE, FIELD, METHOD, PARAMETER, CONSTRUCTOR, LOCAL_VARIABLE&#125;)</span></span><br><span class="line"><span class="meta">@Retention(RetentionPolicy.SOURCE)</span></span><br><span class="line"><span class="keyword">public</span> <span class="meta">@interface</span> SuppressWarnings &#123;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * The set of warnings that are to be suppressed by the compiler in the</span></span><br><span class="line"><span class="comment">     * annotated element.  Duplicate names are permitted.  The second and</span></span><br><span class="line"><span class="comment">     * successive occurrences of a name are ignored.  The presence of</span></span><br><span class="line"><span class="comment">     * unrecognized warning names is &lt;i&gt;not&lt;/i&gt; an error: Compilers must</span></span><br><span class="line"><span class="comment">     * ignore any warning names they do not recognize.  They are, however,</span></span><br><span class="line"><span class="comment">     * free to emit a warning if an annotation contains an unrecognized</span></span><br><span class="line"><span class="comment">     * warning name.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * &lt;p&gt; The string &#123;<span class="doctag">@code</span> &quot;unchecked&quot;&#125; is used to suppress</span></span><br><span class="line"><span class="comment">     * unchecked warnings. Compiler vendors should document the</span></span><br><span class="line"><span class="comment">     * additional warning names they support in conjunction with this</span></span><br><span class="line"><span class="comment">     * annotation type. They are encouraged to cooperate to ensure</span></span><br><span class="line"><span class="comment">     * that the same names work across multiple compilers.</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> the set of warnings to be suppressed</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    String[] value();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>SuppressWarnings</code> 这个注解作用于类型函数等等，并且在代码编辑期间生效。代码编辑期间的注解更多是用于代码检查，如更常见的 <code>Override</code>。</p>
<h3 id="Runtime-Annotation"><a href="#Runtime-Annotation" class="headerlink" title="Runtime-Annotation"></a>Runtime-Annotation</h3><p>runtime annotation 是基于 Java 本身的反射机制来实现，反射指的是在运行期间动态操作类 / 对象，这里先不展开来讲。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Target(ElementType.FIELD)</span></span><br><span class="line"><span class="meta">@Retention(RetentionPolicy.RUNTIME)</span></span><br><span class="line"><span class="meta">@interface</span> JsonKeyField &#123;</span><br><span class="line">    <span class="function">String <span class="title">value</span><span class="params">()</span> <span class="keyword">default</span> &quot;&quot;</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Person</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@JsonKeyField(&quot;first_name&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> String firstName;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@JsonKeyField(&quot;last_name&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> String lastName;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@JsonKeyField()</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">int</span> age;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">Person</span><span class="params">(String firstName, String lastName, <span class="keyword">int</span> age)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.firstName = firstName;</span><br><span class="line">        <span class="keyword">this</span>.lastName = lastName;</span><br><span class="line">        <span class="keyword">this</span>.age = age;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">toJsonStr</span><span class="params">()</span> <span class="keyword">throws</span> JsonProcessingException, IllegalAccessException </span>&#123;</span><br><span class="line">        Map&lt;String, Object&gt; map = <span class="keyword">new</span> HashMap&lt;String, Object&gt;();</span><br><span class="line">        <span class="keyword">for</span> (Field field : <span class="keyword">this</span>.getClass().getDeclaredFields()) &#123;</span><br><span class="line">            <span class="keyword">if</span> (field.isAnnotationPresent(JsonKeyField.class)) &#123;</span><br><span class="line">                JsonKeyField jkf = field.getAnnotation(JsonKeyField.class);</span><br><span class="line">                String key = jkf.value().isEmpty()? field.getName(): jkf.value();</span><br><span class="line">                map.put(key, field.get(<span class="keyword">this</span>));</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> ObjectMapper().writeValueAsString(map);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>上述代码使用注解 <code>JsonKeyField</code> 来规范导出成 JSON 时候的字段，如果没有指定，则沿用原有的成员名字。这里的写法有点类似 Golang 中的 struct tag 的功能，如果有多种格式（如 Msgpack）的需求可以写多个注解。</p>
<p>其实可以看到，注解本身其实只起到一个标记或者说文档的作用，而真正的用处是供外部调用在运行时提供信息给外部进行判断来执行相应的操作。</p>
<p>需要注意的是，注解中只有一个属性，使用 <code>value()</code> 来定义，则使用注解时可以不用指定参数名。常见的用于代码检查的注解和用于运行时检查的注解，还有编译时使用的注解，后者这边就不进行讨论了。</p>
<h2 id="Generics"><a href="#Generics" class="headerlink" title="Generics"></a>Generics</h2><p>泛型</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">GenericBox</span>&lt;<span class="title">T</span>&gt;  </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> T item;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> T <span class="title">getItem</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> item;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setItem</span><span class="params">(T item)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.item = item;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Box&lt;String&gt; box = new Box&lt;&gt;();</span></span><br></pre></td></tr></table></figure>

<p>这里需要注意的是，泛型中的类型不能是基础类型（如 int，char），你可以是任何的类，接口。</p>
<p>这里有个约定的类型命名</p>
<ul>
<li>E - Element (used extensively by the Java Collections Framework)</li>
<li>K - Key</li>
<li>N - Number</li>
<li>T - Type</li>
<li>V - Value</li>
<li>S,U,V etc. - 2nd, 3rd, 4th types</li>
</ul>
<h3 id="Generic-Method"><a href="#Generic-Method" class="headerlink" title="Generic-Method"></a>Generic-Method</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">interface</span> <span class="title">Pair</span>&lt;<span class="title">K</span>, <span class="title">V</span>&gt; </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> K <span class="title">getKey</span><span class="params">()</span></span>;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> V <span class="title">getValue</span><span class="params">()</span></span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">OrderedPair</span>&lt;<span class="title">K</span>, <span class="title">V</span>&gt; <span class="keyword">implements</span> <span class="title">Pair</span>&lt;<span class="title">K</span>, <span class="title">V</span>&gt; </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> K key;</span><br><span class="line">    <span class="keyword">private</span> V value;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">OrderedPair</span><span class="params">(K key, V value)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.key = key;</span><br><span class="line">        <span class="keyword">this</span>.value = value;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> K <span class="title">getKey</span><span class="params">()</span>	</span>&#123; <span class="keyword">return</span> key; &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> V <span class="title">getValue</span><span class="params">()</span> </span>&#123; <span class="keyword">return</span> value; &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> &lt;K, V&gt; <span class="function"><span class="keyword">boolean</span> <span class="title">equals</span><span class="params">(Pair&lt;K, V&gt; p1, Pair&lt;K, V&gt; p2)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Pair&lt;Integer, String&gt; p1 = new OrderedPair&lt;&gt;(1, &quot;apple&quot;);</span></span><br><span class="line"><span class="comment">// Pair&lt;Integer, String&gt; p2 = new OrderedPair&lt;&gt;(2, &quot;pear&quot;);</span></span><br><span class="line"><span class="comment">// boolean same = OrderedPair.&lt;Integer, String&gt;equals(p1, p2);</span></span><br><span class="line"><span class="comment">// same = OrderedPair.equals(p1, p2); // 1.7+</span></span><br></pre></td></tr></table></figure>

<p>与普通的函数不同的是，上述的泛型方法声明时前面需要添加 <code>&lt;T...&gt;</code></p>
<h3 id="Bounded-Type-Parameter"><a href="#Bounded-Type-Parameter" class="headerlink" title="Bounded-Type-Parameter"></a>Bounded-Type-Parameter</h3><p>当使用泛型时，如尝试在函数内进行比较操作，如果一些自定义类没有实现 compare 相关的方法，则会在运行时报错。这里可以引入泛型边界的用法。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Box</span>&lt;<span class="title">T</span> <span class="keyword">extends</span> <span class="title">Number</span>&gt; </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> T item;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> T <span class="title">getItem</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> item;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setItem</span><span class="params">(T item)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.item = item;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Box&lt;Number&gt; box = new Box&lt;&gt;();</span></span><br></pre></td></tr></table></figure>

<p>如果使用类不是 Number 或者不是继承了 Number 的类则会在编译时报错。此外也可以添加多个约束，语法为 <code>&lt;T extends B1 &amp; B2 &amp; B3&gt;</code></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Data</span> <span class="keyword">implements</span> <span class="title">Comparable</span>&lt;<span class="title">Data</span>&gt; </span>&#123;</span><br><span class="line">    <span class="keyword">int</span> data;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">compareTo</span><span class="params">(Data d)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> data - d.data;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">function</span><span class="params">(Box&lt;Double&gt; bi)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Box</span>&lt;<span class="title">T</span> <span class="keyword">extends</span> <span class="title">Comparable</span>&lt;<span class="title">T</span>&gt;&gt; </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> T item;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> T <span class="title">getItem</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> item;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setItem</span><span class="params">(T item)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.item = item;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">f</span><span class="params">(List&lt;Number&gt; l)</span> </span>&#123;</span><br><span class="line">        ;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Data data = new Data();</span></span><br><span class="line"><span class="comment">// Box&lt;Data&gt; box = new Box&lt;&gt;();</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// Box.f(Arrays.asList(1, 2, 3, 4)); // Error</span></span><br></pre></td></tr></table></figure>

<p>也可以使用接口去限制，这里则是要求必须实现 <code>Comparable</code> 接口。这里需要注意的是，像上述代码 <code>Box</code> 中像方法 <code>f</code> 如果试图传入 <code>List&lt;Integer&gt;</code> 则会报错。</p>
<p><code>Integer</code> 的确是 <code>Number</code> 子类，但 <code>Box&lt;Integer&gt;</code> 不是 <code>Box&lt;Number&gt;</code> 的子类，准确来说两者没有任何关系，他们的父类均是 <code>Object</code>。另一方面 <code>ArrayList&lt;String&gt;</code> 的父类是 <code>List&lt;String&gt;</code> 并以此类推。</p>
<h3 id="Type-Inference"><a href="#Type-Inference" class="headerlink" title="Type-Inference"></a>Type-Inference</h3><p>类型推断</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">Map&lt;String, List&lt;String&gt;&gt; myMap = <span class="keyword">new</span> HashMap&lt;String, List&lt;String&gt;&gt;();</span><br><span class="line">Map&lt;String, List&lt;String&gt;&gt; myMap1 = <span class="keyword">new</span> HashMap&lt;&gt;();</span><br></pre></td></tr></table></figure>

<p>上述两种调用都是合法的，需要注意的是 <code>HashMap</code> 后面的 <code>&lt;&gt;</code> 不能忽略。这里涉及更多是编译器的优化，如</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">processStringList</span><span class="params">(List&lt;String&gt; stringList)</span> </span>&#123;</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// processStringList(Collections.emptyList());</span></span><br><span class="line"><span class="comment">// 上述调用在 Java7 会报错，Java8 则不会</span></span><br></pre></td></tr></table></figure>

<p>Java10 更是引进了 var 的类型判断机制，在我看来，写代码的时候借助 IDE 工具一般就能解决这些问题。</p>
<h3 id="Wildcard"><a href="#Wildcard" class="headerlink" title="Wildcard"></a>Wildcard</h3><p>通配符，这里有三种通配符</p>
<ul>
<li>Upper Bounded Wildcard</li>
<li>Unbounded Wildcard</li>
<li>Lower Bounded Wildcard</li>
</ul>
<p>其对应的语法</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Upper Bounded Wildcard</span></span><br><span class="line"><span class="comment">// 表示 Number 或者 Number 的子类都可以</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">double</span> <span class="title">sumOfList</span><span class="params">(List&lt;? extends Number&gt; list)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">double</span> s = <span class="number">0.0</span>;</span><br><span class="line">    <span class="keyword">for</span> (Number n : list)</span><br><span class="line">        s += n.doubleValue();</span><br><span class="line">    <span class="keyword">return</span> s;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Unbounded Wildcard</span></span><br><span class="line"><span class="comment">// 没有任何限制</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">printList</span><span class="params">(List&lt;?&gt; list)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">for</span> (Object elem: list)</span><br><span class="line">        System.out.print(elem + <span class="string">&quot; &quot;</span>);</span><br><span class="line">    System.out.println();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Lower Bounded Wildcard</span></span><br><span class="line"><span class="comment">// Integer 或者 Integer 的父类</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">addNumbers</span><span class="params">(List&lt;? <span class="keyword">super</span> Integer&gt; list)</span> </span>&#123;</span><br><span class="line">	<span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">1</span>; i &lt;= <span class="number">10</span>; i++) &#123;</span><br><span class="line">		list.add(i);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>通配符的使用主要是为了解决诸如 <code>Box&lt;Integer&gt;</code> 不是 <code>Box&lt;Number&gt;</code> 的子类的问题。</p>
<p>对于选择 Upper 还是 Lower，可以以严于律己宽于待人来设计，即</p>
<ul>
<li>对于外部输入，用户调用的参数，选择 Upper Bounded Wildcard，它最终也可以是 null 或者 Object 的子类</li>
<li>对于函数的输出，则应该使用 Lower Bounded Wildcard</li>
</ul>
<h3 id="Type-Erasure"><a href="#Type-Erasure" class="headerlink" title="Type-Erasure"></a>Type-Erasure</h3><p>类型擦除是 Java 泛型的实现方法。编译器在编译的时候去掉了泛型的信息（在 <a target="_blank" rel="noopener" href="https://stackoverflow.com/questions/313584/what-is-the-concept-of-erasure-in-generics-in-java">这里</a> 可以看到编译和反编译代码的区别）。</p>
<p>和 C++ 不同，C++ 会为每一种类型生成对应的函数，而 Java 则只生成一份代码（以 Object 替代自定义类型 T，以及在某些地方添加类型转换）。</p>
<h2 id="References"><a href="#References" class="headerlink" title="References"></a>References</h2><ol>
<li><a target="_blank" rel="noopener" href="https://stackoverflow.com/questions/20938095/difference-between-final-and-effectively-final">Difference Between Final And Effectively Final</a></li>
<li><a target="_blank" rel="noopener" href="http://blog.oneapm.com/apm-tech/226.html">深入浅出 Java 8 Lambda</a></li>
<li><a target="_blank" rel="noopener" href="https://segmentfault.com/a/1190000009186509">Java 8 Lambda 表达式详解</a></li>
<li><a target="_blank" rel="noopener" href="http://wingjay.com/2017/05/03/Java-%E6%8A%80%E6%9C%AF%E4%B9%8B%E6%B3%A8%E8%A7%A3-Annotation/">Annotation 详解</a></li>
<li><a target="_blank" rel="noopener" href="http://www.importnew.com/13907.html">Java 泛型和类型擦除</a></li>
<li><a target="_blank" rel="noopener" href="http://www.angelikalanger.com/GenericsFAQ/FAQSections/TechnicalDetails.html#FAQ101">Java 类型擦除</a></li>
<li><a target="_blank" rel="noopener" href="https://javarevisited.blogspot.com/2012/01/get-set-default-character-encoding.html">Java Encoding 解析</a></li>
</ol>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://yoursite.com/2018/07/27/get-started-in-java-02/" data-id="ckv3iop7r004wesc8d6nj9df1" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/annotation/" rel="tag">annotation</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/generic/" rel="tag">generic</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/java/" rel="tag">java</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/lambda/" rel="tag">lambda</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-get-started-in-java-01" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2018/07/13/get-started-in-java-01/" class="article-date">
  <time datetime="2018-07-12T16:00:00.000Z" itemprop="datePublished">2018-07-13</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2018/07/13/get-started-in-java-01/">Java 学习记录 01</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>环境：Java8, Idea 社区版，ubuntu 18.04 LTS</p>
<p>背景：基本没有 Java 实战经验，有 Python 和 Golang 的经验</p>
<h2 id="Intro"><a href="#Intro" class="headerlink" title="Intro"></a>Intro</h2><ul>
<li>JVM（Java Virtual Machine，Java 虚拟机）的缩写</li>
<li>JRE（Java Runtime Environment，Java 运行环境），运行 Java 程序所必须的环境的集合，包括 JVM 和 Java 程序所需的核心类库等</li>
<li>JDK（Java Development Kit ，Java 开发工具包）是 Java 语言的软件开发工具包(SDK)。JDK 是提供给 Java 开发人员使用的，其中包含了 Java 的开发工具，也包括了JRE。</li>
</ul>
<p>所以安装了JDK，就不用在单独安装 JRE 了。他们的关系为 JVM &lt;= JRE &lt;= JDK，包含关系</p>
<h2 id="Init"><a href="#Init" class="headerlink" title="Init"></a>Init</h2><p>首先下载 JDK，然后设置相关环境变量</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">export</span> JAVA_HOME=/home/lycheng/bin/jdk</span><br><span class="line"><span class="built_in">export</span> JRE_HOME=/home/lycheng/bin/jdk/jre</span><br><span class="line"><span class="built_in">export</span> PATH=<span class="string">&quot;<span class="variable">$JAVA_HOME</span>/bin:<span class="variable">$PATH</span>&quot;</span></span><br></pre></td></tr></table></figure>

<p><code>which java</code> 看下是否有问题，然后就是 HelloWorld 程序</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">HelloWorldApp</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;Hello World!&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>编译，执行</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">javac main.java</span><br><span class="line"><span class="comment"># 生成 HelloWorldApp.class</span></span><br><span class="line">java HelloWorldApp</span><br></pre></td></tr></table></figure>

<h3 id="Maven"><a href="#Maven" class="headerlink" title="Maven"></a>Maven</h3><p>同样也是下载二进制包，可参考 <a target="_blank" rel="noopener" href="https://maven.apache.org/install.html">Maven 安装指南</a></p>
<p>设置相关环境变量</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">export</span> MAVEN_HOME=<span class="variable">$LOCALBIN</span>/maven</span><br><span class="line"><span class="built_in">export</span> PATH=<span class="string">&quot;<span class="variable">$MAVEN_HOME</span>/bin:<span class="variable">$PATH</span>&quot;</span></span><br></pre></td></tr></table></figure>

<p>Maven 的全局设置在 <code>path/to/maven/conf/settings.yml</code> 可修改其 <code>localRepository</code> 设置本地仓库的地址</p>
<h2 id="Basic-Syntax"><a href="#Basic-Syntax" class="headerlink" title="Basic-Syntax"></a>Basic-Syntax</h2><h3 id="Class"><a href="#Class" class="headerlink" title="Class"></a>Class</h3><p>规则</p>
<ol>
<li>一个源文件中只能有一个 public 类</li>
<li>一个源文件可以有多个非 public 类</li>
<li>源文件的名称应该和 public 类的类名保持一致。例如：源文件中 public 类的类名是 Employee，那么源文件应该命名为 Employee.java</li>
<li>如果一个类定义在某个 package 中，那么 package 语句应该在源文件的首行</li>
<li>如果源文件包含 import 语句，那么应该放在 package 语句和类定义之间。如果没有 package 语句，那么 import 语句应该在源文件中最前面</li>
<li>import 语句和 package 语句对源文件中定义的所有类都有效。在同一源文件中，不能给不同的类不同的包声明</li>
</ol>
<p>class 定义的基本语法</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Animal</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 成员变量</span></span><br><span class="line">    <span class="keyword">private</span> String name;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 类变量</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> String animalType = <span class="string">&quot;cat&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">Animal</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="comment">// 调用其它构造函数</span></span><br><span class="line">        <span class="keyword">this</span>(<span class="string">&quot;default-name&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">Animal</span><span class="params">(String name)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.name = name;</span><br><span class="line">        <span class="comment">// 可以在实例方法中修改类静态变量，会提示 warning</span></span><br><span class="line">        <span class="comment">// this.animalType = &quot;dog&quot;;</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">// 也可以简单的，不提示 warning</span></span><br><span class="line">        <span class="comment">// animalType = &quot;dog&quot;;</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">toString</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="comment">// Override 会去检查父类有没该方法，签名是否对的上</span></span><br><span class="line">        <span class="comment">// 不加的话如果对不上，则会认为是新的方法</span></span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;Animal&#x27;s name is &quot;</span> + name + <span class="string">&quot;, type is &quot;</span> + animalType;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> String <span class="title">getAnimalType</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> animalType;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">setAnimalType</span><span class="params">(String animalType)</span> </span>&#123;</span><br><span class="line">        Animal.animalType = animalType;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>其中 this 的用法</p>
<ul>
<li>当你局部变量有和类实例变量同名时，用来明确表示使用的是类实例变量</li>
<li>当前的对象的引用</li>
<li>调用别的构造函数</li>
</ul>
<h3 id="Inheritance"><a href="#Inheritance" class="headerlink" title="Inheritance"></a>Inheritance</h3><p>Java 中只允许单继承</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Cat</span> <span class="keyword">extends</span> <span class="title">Animal</span></span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">Cat</span><span class="params">(String name)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>(name);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">str</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">super</span>.toString();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>上述的 super(name) 是调用父类的构造函数，第二个 super 则是父类引用，用于调用父类的成员函数。</p>
<p>关于 static 有以下特性</p>
<ul>
<li>在子类调用父类的 static 方法，也会影响到父类</li>
<li>static 的属性不依赖于任何的对象和子类，在内存中只会存在一份副本</li>
<li>static 语句在类加载的时候执行，按顺序执行，并只执行一次</li>
</ul>
<p>需要注意 Java 的类方法和属性在定义的时候可以设定访问权限，对应的关系如下</p>
<table>
<thead>
<tr>
<th>Access Level</th>
<th>Class</th>
<th>Package</th>
<th>Subclass</th>
<th>World</th>
</tr>
</thead>
<tbody><tr>
<td>public</td>
<td>Y</td>
<td>Y</td>
<td>Y</td>
<td>Y</td>
</tr>
<tr>
<td>protected</td>
<td>Y</td>
<td>Y</td>
<td>Y</td>
<td>N</td>
</tr>
<tr>
<td>no</td>
<td>Y</td>
<td>Y</td>
<td>N</td>
<td>N</td>
</tr>
<tr>
<td>private</td>
<td>Y</td>
<td>N</td>
<td>N</td>
<td>N</td>
</tr>
</tbody></table>
<p>可以看到，private 的最严格，public 最松散。</p>
<h3 id="Interface"><a href="#Interface" class="headerlink" title="Interface"></a>Interface</h3><p>interface 简单来说就是规定了类的函数签名</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">Bicycle</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">speedUp</span><span class="params">(<span class="keyword">int</span> incrment)</span></span>;</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">applyBreaks</span><span class="params">(<span class="keyword">int</span> decrement)</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">TheBicycle</span> <span class="keyword">implements</span> <span class="title">Bicycle</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> String brand;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> speed;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">TheBicycle</span><span class="params">(String brand)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.brand = brand;</span><br><span class="line">        <span class="keyword">this</span>.speed = <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">speedUp</span><span class="params">(<span class="keyword">int</span> incrment)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.speed += incrment;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">applyBreaks</span><span class="params">(<span class="keyword">int</span> decrement)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (decrement &gt; <span class="keyword">this</span>.speed) &#123;</span><br><span class="line">            <span class="keyword">this</span>.speed -= decrement;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">this</span>.speed = <span class="number">0</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>与类继承的异同如下</p>
<ul>
<li>类继承仅允许单继承，而接口允许继承（extends）多个接口</li>
<li>类能实例化对象，但接口不能，所以也没有构造函数<ul>
<li>抽象类同样不能实例化，继承其的子类也必须实现父类的抽象方法，其余的非抽象方法则可当做为子类提供的默认实现</li>
</ul>
</li>
<li>接口中可以含有变量，但是接口中的变量会被隐式的指定为 <code>public static final</code> 变量（并且只能是 public，用 private 修饰会报编译错误）</li>
<li>接口被类实现其函数签名</li>
</ul>
<p>有了接口，实际调用的时候，可以通过声明接口的参数，至于其底层实现则不关心</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Main</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">test</span><span class="params">(Transportation t)</span> </span>&#123;</span><br><span class="line">        System.out.println(t);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;Hello World!&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Bicycle 和 Car 都实现了 Transportation 这个接口</span></span><br><span class="line">        Bicycle b = <span class="keyword">new</span> TheBicycle(<span class="string">&quot;Giant&quot;</span>);</span><br><span class="line">        Car c = <span class="keyword">new</span> Car();</span><br><span class="line"></span><br><span class="line">        test(b);</span><br><span class="line">        test(c);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>与继承不同，接口实现这种方式不同的对象可以是完全不相干的，保证其接口是相同的就可以。</p>
<h2 id="Project-Structure"><a href="#Project-Structure" class="headerlink" title="Project-Structure"></a>Project-Structure</h2><h3 id="Package"><a href="#Package" class="headerlink" title="Package"></a>Package</h3><p>首先，一个 java 文件中只能有一个类是 public 的，所以定义多个类的时候必须有多个文件。而多个文件的管理则必须通过 package 来管理。</p>
<p>package 在文件层面看就是同一个文件夹下的不同 java 文件，代码层面就是 . 分隔的模块。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">├── core</span><br><span class="line">│   ├── Bicycle.java</span><br><span class="line">│   ├── Car.java</span><br><span class="line">│   └── Transportation.java</span><br><span class="line">└── Main.java</span><br></pre></td></tr></table></figure>

<p>每一个 Java 文件必须写明来自哪个 package</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> core;</span><br><span class="line"></span><br><span class="line"><span class="comment">// package name 全小写</span></span><br></pre></td></tr></table></figure>

<p>在实际使用的时候可以通过 <code>import</code> 语句来引入系统 / 自定义的 package。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> java.util.Date;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Main</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">test</span><span class="params">(core.Transportation t)</span> </span>&#123;</span><br><span class="line">        System.out.println(t);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;Hello World!&quot;</span>);</span><br><span class="line"></span><br><span class="line">        core.Bicycle b = <span class="keyword">new</span> core.Bicycle(<span class="string">&quot;Giant&quot;</span>);</span><br><span class="line">        core.Car c = <span class="keyword">new</span> core.Car();</span><br><span class="line"></span><br><span class="line">        test(b);</span><br><span class="line">        test(c);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 如果去掉 Date 的 import</span></span><br><span class="line">        <span class="comment">// java.util.Date d = new java.util.Date();</span></span><br><span class="line">        <span class="comment">// 也可以 import java.util.*; 这样也可以不用写完整的类名，但是不推荐</span></span><br><span class="line">        Date d = <span class="keyword">new</span> Date();</span><br><span class="line">        System.out.println(d);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>上述的代码也可以添加 <code>import</code> 语句来简化代码</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> core.Transportation;</span><br><span class="line"><span class="keyword">import</span> core.Bicycle;</span><br><span class="line"><span class="keyword">import</span> core.Car;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Car c = new Car();</span></span><br></pre></td></tr></table></figure>

<p>需要注意的是，package 里面定义的类只有 public 外部（别的 package）才可见。</p>
<p>如果使用通配符 * 来 import 还需要注意的是, * 只会 import 那一层级的类，不会递归查找去 import</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> java.awt.*;</span><br><span class="line"><span class="keyword">import</span> java.awt.color.*; <span class="comment">// 如果想要使用 color 的类，则必须多加一个 import</span></span><br></pre></td></tr></table></figure>

<h4 id="Static-Import"><a href="#Static-Import" class="headerlink" title="Static-Import"></a>Static-Import</h4><p>在类中定义了 static 成员时，如果外部需要使用，则 import 之后需要带上类名 prefix 才能访问。此时就可以使用 static import 就可以减少代码量</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// before</span></span><br><span class="line"><span class="comment">// System.out.println(Math.PI);</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// after</span></span><br><span class="line"><span class="comment">// import static java.lang.Math.PI;</span></span><br><span class="line"></span><br><span class="line">System.out.println(PI);</span><br></pre></td></tr></table></figure>

<p>方便使用的同时也带来了问题，丢失了这些 static 成员的出处，查看代码是容易混乱，谨慎使用。</p>
<h3 id="Naming"><a href="#Naming" class="headerlink" title="Naming"></a>Naming</h3><ol>
<li>驼峰命名</li>
<li>函数，方法，变量以首字母小写的驼峰命名</li>
<li>类，接口以首字母大写的驼峰命名</li>
<li>常量用全大写，下划线分隔的写法</li>
</ol>
<p>企业开发的 package 以域名作为项目的 package 命名，如 <code>com/baidu/www/...</code></p>
<ul>
<li>package 命名为全小写，原则上不加分隔符</li>
<li>Java 的关键字 / 数字开头 不推荐使用</li>
</ul>
<h2 id="References"><a href="#References" class="headerlink" title="References"></a>References</h2><ol>
<li><a target="_blank" rel="noopener" href="https://www.jetbrains.com/idea/features/editions_comparison_matrix.html">Idea 社区版和商业版的区别</a></li>
<li><a target="_blank" rel="noopener" href="http://www.oracle.com/technetwork/java/javase/downloads/jdk8-downloads-2133151.html">JDK 下载</a></li>
<li><a target="_blank" rel="noopener" href="https://docs.oracle.com/javase/tutorial/">Java Tutorial</a></li>
<li><a target="_blank" rel="noopener" href="https://google.github.io/styleguide/javaguide.html">Google Java Style Guide</a></li>
</ol>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://yoursite.com/2018/07/13/get-started-in-java-01/" data-id="ckv3iop6u001cesc8249z12a9" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/java/" rel="tag">java</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-influxdb-intro" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2018/07/01/influxdb-intro/" class="article-date">
  <time datetime="2018-06-30T16:00:00.000Z" itemprop="datePublished">2018-07-01</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2018/07/01/influxdb-intro/">InfluxDB 简介</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>基于 InfluxDB v1.5</p>
<p>本文更新时间</p>
<ul>
<li>2018-07-01: 初版</li>
</ul>
<h2 id="What"><a href="#What" class="headerlink" title="What"></a>What</h2><p>InfluxDB 是时间序列数据库的一种，TSDB 来自维基的定义</p>
<blockquote>
<p>A time series database (TSDB) is a software system that is optimized for handling time series data, arrays of numbers indexed by time (a datetime or a datetime range).</p>
</blockquote>
<p>它适合用于保存大量的与时间相关的数据，例如温度变化，股票指数，如</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">temperature,sensor=a,zone=city val=39.0 1422568543702900257</span><br><span class="line">temperature,sensor=b,zone=city val=39.1 1422568543702900258</span><br><span class="line">temperature,sensor=a,zone=city val=39.0 1422568543702900259</span><br><span class="line">temperature,sensor=b,zone=city val=38.9 1422568543702900260</span><br><span class="line">temperature,sensor=a,zone=city val=39.0 1422568543702900261</span><br><span class="line">temperature,sensor=b,zone=city val=39.0 1422568543702900262</span><br></pre></td></tr></table></figure>

<p>目前常用于作为监控系统的数据源，与之类似的还有 <a target="_blank" rel="noopener" href="https://prometheus.io/">Prometheus</a>。</p>
<h3 id="Concepts"><a href="#Concepts" class="headerlink" title="Concepts"></a>Concepts</h3><p>下面是 InfluxDB 的相关概念</p>
<p>Fields</p>
<ul>
<li>数据域，每一行数据至少需要带一个 Field，数值，布尔或者字符串类型</li>
<li>对数据域的过滤（大于，小于或者在某个范围内）是不经过索引，所有的操作都是全表扫描</li>
</ul>
<p>Tags</p>
<ul>
<li>可选项，存储时都是字符串类型</li>
<li>索引项，用于数据的分类</li>
</ul>
<p>Measurements</p>
<ul>
<li>包含 fields, tags 和其对应的 timestamp</li>
<li>含有相同的 tag 的在同一个 measurement 的数据称为 serie</li>
</ul>
<p>Point</p>
<ul>
<li>一条记录，即包含 measurement, tags, fields</li>
<li>使用 API 使用 Line Protocol 格式提交数据，可以包含 5000 到 10000 的 points</li>
</ul>
<p>与 RDBS 相比，database 概念是类似的，InfluxDB 下的 Measurement 则是对应 table, Tags 则是类似于 multiple-column indexes，Field 则是普通的 Column。</p>
<h3 id="Line-Protocol"><a href="#Line-Protocol" class="headerlink" title="Line Protocol"></a>Line Protocol</h3><p>外部与 InfluxDB 交互的格式，其语法如下：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"># &lt;measurement&gt;[,&lt;tag_key&gt;=&lt;tag_value&gt;[,&lt;tag_key&gt;=&lt;tag_value&gt;]] &lt;field_key&gt;=&lt;field_value&gt;[,&lt;field_key&gt;=&lt;field_value&gt;] [&lt;timestamp&gt;]</span><br><span class="line">http,ver=2.6,modules=content,action=sync,type=consume val=10</span><br></pre></td></tr></table></figure>

<h2 id="How"><a href="#How" class="headerlink" title="How"></a>How</h2><h3 id="Schema-Design"><a href="#Schema-Design" class="headerlink" title="Schema Design"></a>Schema Design</h3><p>最主要需要记住</p>
<blockquote>
<p>tags are indexed, and field are not indexed</p>
</blockquote>
<p><em>For Tag</em></p>
<ul>
<li>tag 应该是有限的数据集（http status code, region, or version）</li>
<li>tag 的数据应该是只包含一种信息，而不是复合的信息</li>
</ul>
<p>复合的信息如 <code>name=us.android.4-0-4</code>，使用这类数据在后期的查询中只能通过正则进行区分，这里应该使用 <code>country=us,os=android,ver=4-0-4</code>。</p>
<p>在前文提过，不同的 tag 的值 field 以一个 serie 来存储，假如你有 2 个 tag，每个 tag 有 N 种不同的值，则最终会有 N ^ 2 个 serie。</p>
<p>因为 InfluxDB 是基于 serie 来做索引，如果在 tag 中插入 UUID 或者随机数一类不确定范围的数据，则会导致 series 数量膨胀导致内存中维护的索引增多，造成系统负载升高。</p>
<p>所以在设计 Schema 的时候需要认真考虑 Tag 的数量和总体的数量。</p>
<p><em>For Measurement</em></p>
<ul>
<li>同 Tag 一样，不应该包含复合的信息</li>
</ul>
<p><em>For Field</em></p>
<ul>
<li>field 的数据没有 index，并且可以在其之上用 function（sum, avg or max），则 field 更应存能表示变化的数据</li>
</ul>
<h3 id="Hardware"><a href="#Hardware" class="headerlink" title="Hardware"></a>Hardware</h3><p>在单个实例和集群的选择上，官网的 <a target="_blank" rel="noopener" href="https://docs.influxdata.com/influxdb/v1.5/guides/hardware_sizing/#general-hardware-guidelines-for-a-single-node">文档</a> 说明了集群和单实例的硬件要求。</p>
<p>单个实例的处理上限为</p>
<ul>
<li>每秒最多 250K 个 Field 的写入</li>
<li>每秒查询小于 25 次</li>
<li>series 数量不超过 100W</li>
</ul>
<p>上述的硬件推荐配置 4-6 核 CPU，8-32 GB 内存，磁盘性能在 500-1000 IOPS（作为参考，7200 转的机械硬盘的 IOPS 在 200 左右）。根据文档所说，InfluxDB 是设计在 SSD 上使用，他们 <em>没有</em> 在机械硬盘上进行过测试。</p>
<p>开源版的集群方案停留在 <code>0.11</code>，之后 InfluxDB 将集群作为企业版的特性，为其加入高可用的支持。</p>
<h3 id="Downsampling-and-data-retention"><a href="#Downsampling-and-data-retention" class="headerlink" title="Downsampling and data-retention"></a>Downsampling and data-retention</h3><p>data-retention （RP）是数据保存的策略。</p>
<p>默认情况下，数据保存是不过期。可以通过自己设置相应的 RP 去覆盖默认的数据来达到定期删除的功能。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&gt; CREATE RETENTION POLICY &quot;two_hours&quot; ON &quot;db&quot; DURATION 2h REPLICATION 1 DEFAULT</span><br></pre></td></tr></table></figure>

<p>Continuous Query (CQ) 则是定期跑的 SQL-like 的命令，用于 downsample 数据（如实时采集，30 分钟做一次求平均到另一个表）。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">&gt; CREATE CONTINUOUS QUERY &quot;cq_30m&quot; ON &quot;db&quot; BEGIN</span><br><span class="line">  SELECT mean(&quot;website&quot;) AS &quot;mean_website&quot;,mean(&quot;phone&quot;) AS &quot;mean_phone&quot;</span><br><span class="line">  INTO &quot;a_year&quot;.&quot;downsampled_orders&quot;</span><br><span class="line">  FROM &quot;orders&quot;</span><br><span class="line">  GROUP BY time(30m)</span><br><span class="line">END</span><br></pre></td></tr></table></figure>

<p>通过设置 RP 来设置原始数据的过期时间，再通过 CQ 设置按不同维度定时聚合到</p>
<h3 id="API"><a href="#API" class="headerlink" title="API"></a>API</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">curl -i -XPOST &#x27;http://localhost:8086/write?db=mydb&#x27; --data-binary &#x27;m,a=1,b=2 c=3,d=4&#x27;</span><br></pre></td></tr></table></figure>

<p>InfluxDB 提供 HTTP 的 API，可以通过 POST 进行数据的更新，需要指定 database，schema 是没有限制的。你需要的是先创建相应的 database。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">curl -i -XPOST http://localhost:8086/query --data-urlencode &quot;q=CREATE DATABASE mydb&quot;</span><br></pre></td></tr></table></figure>

<p>多行的数据以换行进行分隔，最好是每个数据加上 timestamp，否则 InfluxDB 收到数据时会以服务器上的时间来记录。</p>
<h2 id="Conclusion"><a href="#Conclusion" class="headerlink" title="Conclusion"></a>Conclusion</h2><p>适合于</p>
<ul>
<li>数据与时间相关，并且数据按时间顺序添加，对数据批量添加也很友好</li>
<li>更新 / 删除操作少，着重于最近一段时间的读取</li>
<li>数据的重点在于趋势，而不是某个具体的点的数值</li>
</ul>
<p>不擅长</p>
<ul>
<li>UUID 或者随机数标记某一个操作的存储</li>
<li>联合其它的 database 或者 measurement 进行查询</li>
</ul>
<h3 id="Grafana"><a href="#Grafana" class="headerlink" title="Grafana"></a>Grafana</h3><p>InfluxDB 本身作为数据源，配合 <a target="_blank" rel="noopener" href="https://grafana.com/">Grafana</a> 就可以做出一个可配置的监控平台，也可以根据某些值进行报警（基于 Webhook）。</p>
<h2 id="References"><a href="#References" class="headerlink" title="References"></a>References</h2><ol>
<li><a target="_blank" rel="noopener" href="http://liubin.org/blog/2016/02/18/tsdb-intro/">http://liubin.org/blog/2016/02/18/tsdb-intro/</a></li>
<li><a target="_blank" rel="noopener" href="https://db-engines.com/en/ranking/time+series+dbms">https://db-engines.com/en/ranking/time+series+dbms</a></li>
<li><a target="_blank" rel="noopener" href="https://grafana.com/blog/2016/01/05/logs-and-metrics-and-graphs-oh-my/">https://grafana.com/blog/2016/01/05/logs-and-metrics-and-graphs-oh-my/</a></li>
<li><a target="_blank" rel="noopener" href="https://docs.influxdata.com/influxdb/v1.5/concepts/storage_engine/#storage-engine">https://docs.influxdata.com/influxdb/v1.5/concepts/storage_engine/#storage-engine</a></li>
<li><a target="_blank" rel="noopener" href="https://github.com/influxdata/influxdb/blob/master/tsdb/engine/tsm1/DESIGN.md">实现细节</a></li>
</ol>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://yoursite.com/2018/07/01/influxdb-intro/" data-id="ckv3iop6t001aesc8clzc7p9u" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/influxdb/" rel="tag">influxdb</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/metrics/" rel="tag">metrics</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-python-yield" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2017/10/04/python-yield/" class="article-date">
  <time datetime="2017-10-03T16:00:00.000Z" itemprop="datePublished">2017-10-04</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2017/10/04/python-yield/">Python yield 用法示例</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>本文主要关注 Python 中 yield 的相关用法，包括 Python3 中新增的特性。</p>
<h2 id="基础用法"><a href="#基础用法" class="headerlink" title="基础用法"></a>基础用法</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> inspect</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">looper</span>():</span></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;started&quot;</span>)</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">3</span>):</span><br><span class="line">        <span class="keyword">yield</span> i</span><br><span class="line"></span><br><span class="line"><span class="comment"># 此时还没开始执行</span></span><br><span class="line"><span class="comment"># 后面也可以看到他的状态为 GEN_CREATED 即等待开始执行</span></span><br><span class="line">loop = looper()</span><br><span class="line"><span class="built_in">print</span>(inspect.getgeneratorstate(loop)) <span class="comment"># GEN_CREATED</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 调用 next 方法，则往前执行到第一个 yield 后暂停</span></span><br><span class="line"><span class="comment"># 等待下一次调用 next</span></span><br><span class="line"><span class="built_in">print</span>(<span class="built_in">next</span>(loop))</span><br><span class="line"><span class="comment"># started</span></span><br><span class="line"><span class="comment"># 0</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(inspect.getgeneratorstate(loop)) <span class="comment"># GEN_SUSPENDED</span></span><br><span class="line"><span class="built_in">print</span>(<span class="built_in">next</span>(loop)) <span class="comment"># 1</span></span><br><span class="line"></span><br><span class="line">loop = looper()</span><br><span class="line"><span class="comment"># for 语法中它会自动帮你处理 next 调用</span></span><br><span class="line"><span class="comment"># 还会自动处理 StopIteration 的异常并安全退出</span></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> loop:</span><br><span class="line">    <span class="built_in">print</span>(i)</span><br></pre></td></tr></table></figure>

<p>上述代码演示的是 yield 最常见的用法，与普通的函数调用不同，函数体内有 yield 关键字的，并不是像普通的函数一样执行，而且需要手动触发其第一次执行，这里就是通过 next 方法。</p>
<p>这里还有另一种更简单的写法</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 生成器表达式，与 [] 的不同，这里是惰性求值的</span></span><br><span class="line">loop = (x*x <span class="keyword">for</span> x <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">3</span>))</span><br><span class="line"><span class="built_in">print</span>(inspect.getgeneratorstate(loop)) <span class="comment"># GEN_CREATED</span></span><br><span class="line"><span class="built_in">print</span>(<span class="built_in">next</span>(loop)) <span class="comment"># 0</span></span><br><span class="line"><span class="built_in">print</span>(inspect.getgeneratorstate(loop)) <span class="comment"># GEN_SUSPENDED</span></span><br></pre></td></tr></table></figure>

<p>简单来说就是 <strong>保留现场，惰性求值</strong>。</p>
<h2 id="send-close-throw"><a href="#send-close-throw" class="headerlink" title="send, close, throw"></a>send, close, throw</h2><p>yield 生成器除了可以返回值以外，外部还可以通过 send 方法与其通信。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">adder</span>():</span></span><br><span class="line">    ret = <span class="number">0</span></span><br><span class="line">    <span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">        i = <span class="keyword">yield</span> ret</span><br><span class="line">        ret += i</span><br><span class="line"></span><br><span class="line">looper = adder()</span><br><span class="line"><span class="comment"># looper.send(1)</span></span><br><span class="line"><span class="comment"># TypeError: can&#x27;t send non-None value to a just-started generator</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(<span class="built_in">next</span>(looper))  <span class="comment"># 0</span></span><br><span class="line"><span class="built_in">print</span>(<span class="built_in">next</span>(looper)) </span><br><span class="line"><span class="comment"># TypeError: unsupported operand type(s) for +=: &#x27;int&#x27; and &#x27;NoneType&#x27;</span></span><br><span class="line"><span class="comment"># 继续调用 next 传进去的是一个 None，+= 计算时便出现了问题</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 第一次调用 next 去到 yield 处返回 ret，此时值为 0，并暂停</span></span><br><span class="line"><span class="comment"># 后面的代码调用 send 的时候从暂停处恢复，ret += 1 并 yield 返回结果，继续暂停</span></span><br><span class="line"><span class="keyword">for</span> n <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">1</span>, <span class="number">10</span>):</span><br><span class="line">    i = looper.send(n)</span><br><span class="line">    <span class="built_in">print</span>(i) <span class="comment"># 1, 3, 6 ...</span></span><br></pre></td></tr></table></figure>

<p>这里需要注意的激活生成器可以调用 <code>gen.send(None)</code> 来处理，但上述的代码中并没进行对接收到的数据的类型检查，加法会出现问题。</p>
<p>send 是用在和生成器正常交互的，close 和 throw 则是用在关闭或者说处理相应异常逻辑的。相关文档 <a target="_blank" rel="noopener" href="https://docs.python.org/3/reference/expressions.html#generator-iterator-methods">点这里</a>。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">looper.close()</span><br><span class="line"><span class="built_in">print</span>(inspect.getgeneratorstate(looper))  <span class="comment"># GEN_CLOSED</span></span><br></pre></td></tr></table></figure>

<p>close 在 yield 暂停处 raise 一个 GenerationExit 的异常（需要注意的是，这类异常不能用通用的 Exception 去捕捉）。如果不处理这异常，则在调用方不会报错，如果忽略该异常，则会报 RuntimeError。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">echo</span>(<span class="params">v=<span class="literal">None</span></span>):</span></span><br><span class="line">    <span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            v = (<span class="keyword">yield</span> v)</span><br><span class="line">        <span class="keyword">except</span> Exception <span class="keyword">as</span> ex:</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">&quot;common exception&quot;</span>)</span><br><span class="line">        <span class="keyword">except</span> GeneratorExit <span class="keyword">as</span> ex:</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">&quot;gen exit&quot;</span>)</span><br><span class="line">            <span class="keyword">return</span></span><br><span class="line"></span><br><span class="line">g = echo()</span><br><span class="line"><span class="built_in">next</span>(g)</span><br><span class="line">g.close()</span><br><span class="line"><span class="comment"># RuntimeError: generator ignored GeneratorExit</span></span><br></pre></td></tr></table></figure>

<p>throw 则是外部传入一个异常，需要生成器自身去处理。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">echo</span>():</span></span><br><span class="line">    i = <span class="number">0</span></span><br><span class="line">    <span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">        i += <span class="number">1</span></span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            <span class="keyword">yield</span> i</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">&#x27;aha&#x27;</span>)</span><br><span class="line">        <span class="keyword">except</span> TypeError <span class="keyword">as</span> ex: <span class="comment"># 如果异常不处理，则会往上冒泡，传给调用方</span></span><br><span class="line">            <span class="built_in">print</span>(ex, i)</span><br><span class="line">        <span class="keyword">except</span> GeneratorExit:</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">&quot;gen exit&quot;</span>, i) <span class="comment"># 这个会在程序结束的时候自动调用</span></span><br><span class="line">            <span class="keyword">return</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">g = echo()</span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;from generator:&quot;</span>, <span class="built_in">next</span>(g))</span><br><span class="line"><span class="built_in">print</span>(g.throw(TypeError, <span class="string">&quot;TypeError: from caller&quot;</span>)) <span class="comment"># 2</span></span><br><span class="line"><span class="built_in">print</span>(<span class="built_in">next</span>(g))</span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;END&quot;</span>)</span><br></pre></td></tr></table></figure>

<p>如果处理了 throw 传入的异常，则会往前执行到下一个 yield 处，并且将那个 yield 的返回值作为 throw 的返回值。上述代码一个有意思的地方是，GeneratorExit 会在程序结束时自动调用，一般还是来说不用主动处理该异常。</p>
<h2 id="yield-from"><a href="#yield-from" class="headerlink" title="yield from"></a>yield from</h2><p>yield from 是一个 Python3.3 之后新增的 <a target="_blank" rel="noopener" href="https://docs.python.org/3/whatsnew/3.3.html#pep-380">语法</a>，对于简单的生成器，<code>yield from iterable</code> 是这个 <code>for item in iterable: yield item</code> 的缩写。下面举一个简单的例子</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> inspect</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">adder</span>():</span></span><br><span class="line">    <span class="string">&#x27;&#x27;&#x27; 子生成器</span></span><br><span class="line"><span class="string">    &#x27;&#x27;&#x27;</span></span><br><span class="line">    ret = <span class="number">0</span></span><br><span class="line">    <span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">        n = <span class="keyword">yield</span></span><br><span class="line">        <span class="keyword">if</span> n <span class="keyword">is</span> <span class="literal">None</span>:</span><br><span class="line">            <span class="keyword">break</span></span><br><span class="line">        ret += n</span><br><span class="line">    <span class="comment"># 作为 yield from 的返回值</span></span><br><span class="line">    <span class="comment"># 一般的生成器 send(None) 之后将抛出 StopIteration 的异常</span></span><br><span class="line">    <span class="keyword">return</span> ret  <span class="comment"># 作为 yield from 的返回值</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">worker</span>(<span class="params">result, key</span>):</span></span><br><span class="line">    <span class="string">&#x27;&#x27;&#x27; 委派生成器</span></span><br><span class="line"><span class="string">    &#x27;&#x27;&#x27;</span></span><br><span class="line">    <span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">        rv = <span class="keyword">yield</span> <span class="keyword">from</span> adder()</span><br><span class="line">        result[key] = rv</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">main</span>():</span></span><br><span class="line">    <span class="string">&#x27;&#x27;&#x27; 调用方</span></span><br><span class="line"><span class="string">    &#x27;&#x27;&#x27;</span></span><br><span class="line">    result = &#123;&#125;</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">1</span>, <span class="number">3</span>):</span><br><span class="line">        w = worker(result, i)</span><br><span class="line">        <span class="comment"># 这里每次都会新建一个委派生成器，原因是为了传入 i 作为 reuslt 的 key 值</span></span><br><span class="line">        <span class="comment"># 实际上也可以放到循环外，result 改成 list 就好</span></span><br><span class="line">        <span class="built_in">next</span>(w)</span><br><span class="line">        <span class="keyword">for</span> j <span class="keyword">in</span> <span class="built_in">range</span>(i, i+<span class="number">3</span>):</span><br><span class="line">            w.send(j)</span><br><span class="line">        w.send(<span class="literal">None</span>)</span><br><span class="line">        <span class="comment"># 这里 send None 之后委派生成器会更新 reuslt 的值，再起另一个生成器继续等待</span></span><br><span class="line">        <span class="built_in">print</span>(inspect.getgeneratorstate(w))  <span class="comment"># GEN_SUSPENDED</span></span><br><span class="line">    <span class="built_in">print</span>(result)</span><br><span class="line"></span><br><span class="line">main()</span><br></pre></td></tr></table></figure>

<p>上述代码就简单的演示了下 yield from 是怎么工作的。yield from 的实际功能相当复杂，这里篇幅有限就不展开来讲。</p>
<p>这里面比较关键的是，委派生成器（即介于调用者和子生成器中间的函数）对于 send 的处理。通过委派生成器调用 send 都会直接传给子生成器，send(None) 时，会调用子生成器的 __next__ 方法，send 的参数不为 None 则调用子生成器的 send 方法。</p>
<p>如果子生成器抛出的异常为 StopIteration，那么委派生成器恢复执行，其它异常则照常抛出，需要委派生成器自己去处理。子生成器退出时，return expr 语句将会触发 StopIteration(expr) 的异常。</p>
<h2 id="写在最后"><a href="#写在最后" class="headerlink" title="写在最后"></a>写在最后</h2><p>以前写代码的时候比较少用 yield 这个语法，单纯的 yield 还好，如果是加上类似协程的相关代码后，就感觉难以理解了。相比 return 处理起来就习惯多了，学习的时候也更多是知道这个语法的用法。</p>
<p>后来 Python3 之后很多接口改成了迭代器的模式，自己才开始去看类似的代码，写了下感觉还好，用来处理数据生成和逻辑代码的解耦真是太舒服了。</p>
<h2 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h2><ol>
<li><a target="_blank" rel="noopener" href="https://www.python.org/dev/peps/pep-0255/">PEP-255</a></li>
<li><a target="_blank" rel="noopener" href="https://www.python.org/dev/peps/pep-0380/">PEP-380</a></li>
<li><a target="_blank" rel="noopener" href="http://stackoverflow.com/questions/9708902/in-practice-what-are-the-main-uses-for-the-new-yield-from-syntax-in-python-3">Stackoverflow 上一个关于 Python3 yield from 语法的问题</a></li>
<li><a target="_blank" rel="noopener" href="http://flupy.org/resources/yield-from.pdf">Python3 yield from 解析</a></li>
</ol>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://yoursite.com/2017/10/04/python-yield/" data-id="ckv3iop6r0018esc8art90jjz" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/python/" rel="tag">python</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-mysql-partitions" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2017/08/26/mysql-partitions/" class="article-date">
  <time datetime="2017-08-25T16:00:00.000Z" itemprop="datePublished">2017-08-26</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2017/08/26/mysql-partitions/">MySQL 分区实践</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>在项目中有需要优化之前有涉及分区的表，这里记录下不同的分区方法的相关测试。</p>
<h2 id="基础"><a href="#基础" class="headerlink" title="基础"></a>基础</h2><p>在未来，native 的分区功能会被移除，只有在 InnoDB 和 NDB 才会继续保存该功能，本文是以 InnoDB 为例进行说明。简单来说，分区是指在根据表的某种用户自定义的规则，将数据分到不同的物理存储的文件中。在外部看来，这个表还是一样的，只是在 query 的时候，会根据具体的分区规则查询具体的分区。</p>
<h2 id="hash"><a href="#hash" class="headerlink" title="hash"></a>hash</h2><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> IF <span class="keyword">NOT</span> <span class="keyword">EXISTS</span> `origin` (</span><br><span class="line">    a <span class="type">bigint</span>(<span class="number">20</span>) <span class="keyword">NOT</span> <span class="keyword">NULL</span> <span class="keyword">DEFAULT</span> <span class="string">&#x27;0&#x27;</span>,</span><br><span class="line">    b <span class="type">bigint</span>(<span class="number">20</span>) UNSIGNED <span class="keyword">NOT</span> <span class="keyword">NULL</span>,</span><br><span class="line">    c <span class="type">int</span>(<span class="number">10</span>) UNSIGNED <span class="keyword">NOT</span> <span class="keyword">NULL</span>,</span><br><span class="line">    d <span class="type">int</span>(<span class="number">10</span>) UNSIGNED <span class="keyword">NOT</span> <span class="keyword">NULL</span>,</span><br><span class="line">    e tinyint(<span class="number">4</span>) UNSIGNED <span class="keyword">NOT</span> <span class="keyword">NULL</span>,</span><br><span class="line">    f <span class="type">bigint</span>(<span class="number">20</span>) UNSIGNED <span class="keyword">NOT</span> <span class="keyword">NULL</span>,</span><br><span class="line">    g <span class="type">char</span>(<span class="number">2</span>) <span class="keyword">NOT</span> <span class="keyword">NULL</span>,</span><br><span class="line">    h <span class="type">date</span> <span class="keyword">NOT</span> <span class="keyword">NULL</span>,</span><br><span class="line">    <span class="keyword">PRIMARY</span> KEY (`a`,`b`,`c`,`d`,`e`,`f`,`g`,`h`) <span class="keyword">USING</span> BTREE,</span><br><span class="line">    KEY `aid<span class="operator">-</span>country` (`a`,`g`) <span class="keyword">USING</span> BTREE,</span><br><span class="line">    KEY `ctid<span class="operator">-</span>country` (`b`,`g`) <span class="keyword">USING</span> BTREE,</span><br><span class="line">    KEY `product<span class="operator">-</span>country` (`c`,`g`) <span class="keyword">USING</span> BTREE</span><br><span class="line">) ENGINE<span class="operator">=</span>InnoDB <span class="keyword">DEFAULT</span> CHARSET<span class="operator">=</span>utf8</span><br><span class="line"><span class="keyword">PARTITION</span> <span class="keyword">BY</span> LINEAR HASH (<span class="keyword">YEAR</span>(`h`) <span class="operator">*</span> <span class="number">10000</span> <span class="operator">+</span> <span class="keyword">MONTH</span>(`h`) <span class="operator">*</span> <span class="number">100</span> <span class="operator">+</span> <span class="keyword">DAY</span>(`h`))</span><br><span class="line">PARTITIONS <span class="number">8</span>;</span><br></pre></td></tr></table></figure>

<p>旨在优化的原始表的大体结构如上。里面的字段与实际表相比，只是少了部分的数据字段，索引和分区策略是一样的。当前的问题是，在这样子的分区策略下，查询的效率低下（特别是对 h 字段的跨日 \ 跨月查询），常见的是会去通过 h 做范围查询。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; explain select * from origin where c = 1 and g = &#x27;AD&#x27; and h = &#x27;2017-01-02&#x27; limit 1 \G;</span><br><span class="line">*************************** 1. row ***************************</span><br><span class="line">           id: 1</span><br><span class="line">  select_type: SIMPLE</span><br><span class="line">        table: origin</span><br><span class="line">   partitions: p6</span><br><span class="line">         type: ref</span><br><span class="line">possible_keys: product-country</span><br><span class="line">          key: product-country</span><br><span class="line">      key_len: 10</span><br><span class="line">          ref: const,const</span><br><span class="line">         rows: 5</span><br><span class="line">     filtered: 10.00</span><br><span class="line">        Extra: Using where; Using index</span><br><span class="line">1 row in set, 1 warning (0.00 sec)</span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; explain select * from origin where c = 1 and g = &#x27;AD&#x27; and h &gt; &#x27;2017-01-02&#x27; limit 1 \G;</span><br><span class="line">*************************** 1. row ***************************</span><br><span class="line">           id: 1</span><br><span class="line">  select_type: SIMPLE</span><br><span class="line">        table: origin</span><br><span class="line">   partitions: p0,p1,p2,p3,p4,p5,p6,p7</span><br><span class="line">         type: ref</span><br><span class="line">possible_keys: product-country</span><br><span class="line">          key: product-country</span><br><span class="line">      key_len: 10</span><br><span class="line">          ref: const,const</span><br><span class="line">         rows: 45</span><br><span class="line">     filtered: 33.33</span><br><span class="line">        Extra: Using where; Using index</span><br><span class="line">1 row in set, 1 warning (0.00 sec)</span><br></pre></td></tr></table></figure>

<p>origin 表的测试数据为 99999 条，上面的结果可以看到，两个语句都能使用到索引，但是不同的是，后者需要扫所有的分区，以至于其所扫的 rows 比前者多。这里我们可以得出结论</p>
<ol>
<li>hash 分区的字段不适合范围或者比较查询，如果在 where 条件中涉及到 hash；</li>
<li>所涉及的字段，应该使用相等判断（不等于也不行）索引是在分区之后的数据范围内查询。</li>
</ol>
<p>上述的测试结果与我们日常的使用经验相吻合，我们希望找到方法可以做范围查询。</p>
<h2 id="range-分区"><a href="#range-分区" class="headerlink" title="range 分区"></a>range 分区</h2><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> IF <span class="keyword">NOT</span> <span class="keyword">EXISTS</span> `month_field` (</span><br><span class="line">    a <span class="type">bigint</span>(<span class="number">20</span>) <span class="keyword">NOT</span> <span class="keyword">NULL</span> <span class="keyword">DEFAULT</span> <span class="string">&#x27;0&#x27;</span>,</span><br><span class="line">    b <span class="type">bigint</span>(<span class="number">20</span>) UNSIGNED <span class="keyword">NOT</span> <span class="keyword">NULL</span>,</span><br><span class="line">    c <span class="type">int</span>(<span class="number">10</span>) UNSIGNED <span class="keyword">NOT</span> <span class="keyword">NULL</span>,</span><br><span class="line">    d <span class="type">int</span>(<span class="number">10</span>) UNSIGNED <span class="keyword">NOT</span> <span class="keyword">NULL</span>,</span><br><span class="line">    e tinyint(<span class="number">4</span>) UNSIGNED <span class="keyword">NOT</span> <span class="keyword">NULL</span>,</span><br><span class="line">    f <span class="type">bigint</span>(<span class="number">20</span>) UNSIGNED <span class="keyword">NOT</span> <span class="keyword">NULL</span>,</span><br><span class="line">    g <span class="type">char</span>(<span class="number">2</span>) <span class="keyword">NOT</span> <span class="keyword">NULL</span>,</span><br><span class="line">    h <span class="type">date</span> <span class="keyword">NOT</span> <span class="keyword">NULL</span>,</span><br><span class="line">    m <span class="type">int</span>(<span class="number">10</span>) <span class="keyword">NOT</span> <span class="keyword">NULL</span>,</span><br><span class="line">    <span class="keyword">PRIMARY</span> KEY (`a`,`b`,`c`,`d`,`e`,`f`,`g`,`h`, `m`) <span class="keyword">USING</span> BTREE,</span><br><span class="line">    KEY `aid<span class="operator">-</span>country` (`a`,`g`) <span class="keyword">USING</span> BTREE,</span><br><span class="line">    KEY `ctid<span class="operator">-</span>country` (`b`,`g`) <span class="keyword">USING</span> BTREE,</span><br><span class="line">    KEY `product<span class="operator">-</span>country` (`c`,`g`) <span class="keyword">USING</span> BTREE</span><br><span class="line">) ENGINE<span class="operator">=</span>InnoDB <span class="keyword">DEFAULT</span> CHARSET<span class="operator">=</span>utf8</span><br><span class="line"><span class="keyword">PARTITION</span> <span class="keyword">BY</span> <span class="keyword">RANGE</span>(m) (</span><br><span class="line">    <span class="keyword">PARTITION</span> p0 <span class="keyword">VALUES</span> LESS THAN (<span class="number">201701</span>),</span><br><span class="line">    <span class="keyword">PARTITION</span> p1 <span class="keyword">VALUES</span> LESS THAN (<span class="number">201702</span>),</span><br><span class="line">    <span class="keyword">PARTITION</span> p2 <span class="keyword">VALUES</span> LESS THAN (<span class="number">201703</span>),</span><br><span class="line">    <span class="keyword">PARTITION</span> p3 <span class="keyword">VALUES</span> LESS THAN (<span class="number">201704</span>),</span><br><span class="line">    <span class="keyword">PARTITION</span> p4 <span class="keyword">VALUES</span> LESS THAN (<span class="number">201705</span>),</span><br><span class="line">    <span class="keyword">PARTITION</span> p5 <span class="keyword">VALUES</span> LESS THAN (<span class="number">201706</span>),</span><br><span class="line">    <span class="keyword">PARTITION</span> p6 <span class="keyword">VALUES</span> LESS THAN (<span class="number">201707</span>),</span><br><span class="line">    <span class="keyword">PARTITION</span> p7 <span class="keyword">VALUES</span> LESS THAN MAXVALUE</span><br><span class="line">);</span><br></pre></td></tr></table></figure>

<p>上述 SQL 是另一种分区模式，通过 range 分区，与 hash 不同的是，其需要指定某些字段具体的范围确定到某个分区。month_field 这个表与之前的相比，只是加多了一个 m 字段来存相应的月份的信息，如 201701。</p>
<p>这里需要注意的是这个新增的 m 字段也加到了主键中，原因是 MySQL  本身有约束，用于分区的字段，<a target="_blank" rel="noopener" href="https://dev.mysql.com/doc/refman/5.7/en/partitioning-limitations-partitioning-keys-unique-keys.html">必须在所有的唯一索引列</a>。</p>
<blockquote>
<p>every unique key on the table must use every column in the table’s partitioning expression.</p>
</blockquote>
<p>下面测试范围查找和精确查找</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; explain select * from month_field where c = 1 and g = &#x27;AD&#x27; and m &lt;= 201703 limit 1 \G;</span><br><span class="line">*************************** 1. row ***************************</span><br><span class="line">           id: 1</span><br><span class="line">  select_type: SIMPLE</span><br><span class="line">        table: month_field</span><br><span class="line">   partitions: p0,p1,p2,p3</span><br><span class="line">         type: ref</span><br><span class="line">possible_keys: product-country</span><br><span class="line">          key: product-country</span><br><span class="line">      key_len: 10</span><br><span class="line">          ref: const,const</span><br><span class="line">         rows: 2</span><br><span class="line">     filtered: 33.33</span><br><span class="line">        Extra: Using where; Using index</span><br><span class="line">1 row in set, 1 warning (0.00 sec)</span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; explain select * from month_field where c = 1 and g = &#x27;AD&#x27; and m = 201703 limit 1 \G;</span><br><span class="line">*************************** 1. row ***************************</span><br><span class="line">           id: 1</span><br><span class="line">  select_type: SIMPLE</span><br><span class="line">        table: month_field</span><br><span class="line">   partitions: p3</span><br><span class="line">         type: ref</span><br><span class="line">possible_keys: product-country</span><br><span class="line">          key: product-country</span><br><span class="line">      key_len: 10</span><br><span class="line">          ref: const,const</span><br><span class="line">         rows: 1</span><br><span class="line">     filtered: 10.00</span><br><span class="line">        Extra: Using where; Using index</span><br><span class="line">1 row in set, 1 warning (0.00 sec)</span><br></pre></td></tr></table></figure>

<p>第一个查询可以看出来，对其是用范围查询，也能根据分区策略只查对应的分区而不用像 hash 那样去扫全部的分区。同样的精确查找能去到指定的分区。与 hash 相比，这种分区策略适合有范围并且分布均衡的数据。后期也可以根据需要定期扩展分区。</p>
<h2 id="range-中二次计算"><a href="#range-中二次计算" class="headerlink" title="range 中二次计算"></a>range 中二次计算</h2><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> IF <span class="keyword">NOT</span> <span class="keyword">EXISTS</span> `origin` (</span><br><span class="line">    a <span class="type">bigint</span>(<span class="number">20</span>) <span class="keyword">NOT</span> <span class="keyword">NULL</span> <span class="keyword">DEFAULT</span> <span class="string">&#x27;0&#x27;</span>,</span><br><span class="line">    b <span class="type">bigint</span>(<span class="number">20</span>) UNSIGNED <span class="keyword">NOT</span> <span class="keyword">NULL</span>,</span><br><span class="line">    c <span class="type">int</span>(<span class="number">10</span>) UNSIGNED <span class="keyword">NOT</span> <span class="keyword">NULL</span>,</span><br><span class="line">    d <span class="type">int</span>(<span class="number">10</span>) UNSIGNED <span class="keyword">NOT</span> <span class="keyword">NULL</span>,</span><br><span class="line">    e tinyint(<span class="number">4</span>) UNSIGNED <span class="keyword">NOT</span> <span class="keyword">NULL</span>,</span><br><span class="line">    f <span class="type">bigint</span>(<span class="number">20</span>) UNSIGNED <span class="keyword">NOT</span> <span class="keyword">NULL</span>,</span><br><span class="line">    g <span class="type">char</span>(<span class="number">2</span>) <span class="keyword">NOT</span> <span class="keyword">NULL</span>,</span><br><span class="line">    h <span class="type">date</span> <span class="keyword">NOT</span> <span class="keyword">NULL</span>,</span><br><span class="line">    <span class="keyword">PRIMARY</span> KEY (`a`,`b`,`c`,`d`,`e`,`f`,`g`,`h`) <span class="keyword">USING</span> BTREE,</span><br><span class="line">    KEY `aid<span class="operator">-</span>country` (`a`,`g`) <span class="keyword">USING</span> BTREE,</span><br><span class="line">    KEY `ctid<span class="operator">-</span>country` (`b`,`g`) <span class="keyword">USING</span> BTREE,</span><br><span class="line">    KEY `product<span class="operator">-</span>country` (`c`,`g`) <span class="keyword">USING</span> BTREE</span><br><span class="line">) ENGINE<span class="operator">=</span>InnoDB <span class="keyword">DEFAULT</span> CHARSET<span class="operator">=</span>utf8</span><br><span class="line"><span class="keyword">PARTITION</span> <span class="keyword">BY</span> <span class="keyword">RANGE</span>(<span class="keyword">YEAR</span>(`h`)<span class="operator">*</span><span class="number">100</span> <span class="operator">+</span> <span class="keyword">MONTH</span>(`h`)) (</span><br><span class="line">    <span class="keyword">PARTITION</span> p0 <span class="keyword">VALUES</span> LESS THAN (<span class="number">201701</span>),</span><br><span class="line">    <span class="keyword">PARTITION</span> p1 <span class="keyword">VALUES</span> LESS THAN (<span class="number">201702</span>),</span><br><span class="line">    <span class="keyword">PARTITION</span> p2 <span class="keyword">VALUES</span> LESS THAN (<span class="number">201703</span>),</span><br><span class="line">    <span class="keyword">PARTITION</span> p3 <span class="keyword">VALUES</span> LESS THAN (<span class="number">201704</span>),</span><br><span class="line">    <span class="keyword">PARTITION</span> p4 <span class="keyword">VALUES</span> LESS THAN (<span class="number">201705</span>),</span><br><span class="line">    <span class="keyword">PARTITION</span> p5 <span class="keyword">VALUES</span> LESS THAN (<span class="number">201706</span>),</span><br><span class="line">    <span class="keyword">PARTITION</span> p6 <span class="keyword">VALUES</span> LESS THAN (<span class="number">201707</span>),</span><br><span class="line">    <span class="keyword">PARTITION</span> p7 <span class="keyword">VALUES</span> LESS THAN MAXVALUE</span><br><span class="line">);</span><br></pre></td></tr></table></figure>

<p>这里有一种特殊情况，在 range 中的值如果是是通过某些字段的值二次运算算出来的话，范围查询时也是会扫所有的分区。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; explain select * from origin where c = 1 and g = &#x27;AD&#x27; and h &gt;= &#x27;2017-06-24&#x27; limit 1 \G;</span><br><span class="line">*************************** 1. row ***************************</span><br><span class="line">           id: 1</span><br><span class="line">  select_type: SIMPLE</span><br><span class="line">        table: origin</span><br><span class="line">   partitions: p0,p1,p2,p3,p4,p5,p6,p7</span><br><span class="line">         type: ref</span><br><span class="line">possible_keys: product-country</span><br><span class="line">          key: product-country</span><br><span class="line">      key_len: 10</span><br><span class="line">          ref: const,const</span><br><span class="line">         rows: 43</span><br><span class="line">     filtered: 33.33</span><br><span class="line">        Extra: Using where; Using index</span><br><span class="line">1 row in set, 1 warning (0.00 sec)</span><br></pre></td></tr></table></figure>

<h2 id="list-分区"><a href="#list-分区" class="headerlink" title="list 分区"></a>list 分区</h2><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> IF <span class="keyword">NOT</span> <span class="keyword">EXISTS</span> `list` (</span><br><span class="line">    a <span class="type">bigint</span>(<span class="number">20</span>) <span class="keyword">NOT</span> <span class="keyword">NULL</span> <span class="keyword">DEFAULT</span> <span class="string">&#x27;0&#x27;</span>,</span><br><span class="line">    b <span class="type">bigint</span>(<span class="number">20</span>) UNSIGNED <span class="keyword">NOT</span> <span class="keyword">NULL</span>,</span><br><span class="line">    c <span class="type">int</span>(<span class="number">10</span>) UNSIGNED <span class="keyword">NOT</span> <span class="keyword">NULL</span>,</span><br><span class="line">    d <span class="type">int</span>(<span class="number">10</span>) UNSIGNED <span class="keyword">NOT</span> <span class="keyword">NULL</span>,</span><br><span class="line">    e tinyint(<span class="number">4</span>) UNSIGNED <span class="keyword">NOT</span> <span class="keyword">NULL</span>,</span><br><span class="line">    f <span class="type">bigint</span>(<span class="number">20</span>) UNSIGNED <span class="keyword">NOT</span> <span class="keyword">NULL</span>,</span><br><span class="line">    g <span class="type">char</span>(<span class="number">2</span>) <span class="keyword">NOT</span> <span class="keyword">NULL</span>,</span><br><span class="line">    h <span class="type">date</span> <span class="keyword">NOT</span> <span class="keyword">NULL</span>,</span><br><span class="line">    m <span class="type">int</span>(<span class="number">10</span>) <span class="keyword">NOT</span> <span class="keyword">NULL</span>,</span><br><span class="line">    <span class="keyword">PRIMARY</span> KEY (`a`,`b`,`c`,`d`,`e`,`f`,`g`,`h`, `m`) <span class="keyword">USING</span> BTREE,</span><br><span class="line">    KEY `aid<span class="operator">-</span>country` (`a`,`g`) <span class="keyword">USING</span> BTREE,</span><br><span class="line">    KEY `ctid<span class="operator">-</span>country` (`b`,`g`) <span class="keyword">USING</span> BTREE,</span><br><span class="line">    KEY `product<span class="operator">-</span>country` (`c`,`g`) <span class="keyword">USING</span> BTREE</span><br><span class="line">) ENGINE<span class="operator">=</span>InnoDB <span class="keyword">DEFAULT</span> CHARSET<span class="operator">=</span>utf8</span><br><span class="line"><span class="keyword">PARTITION</span> <span class="keyword">BY</span> LIST COLUMNS(m) (</span><br><span class="line">    <span class="keyword">PARTITION</span> p0 <span class="keyword">VALUES</span> <span class="keyword">IN</span> (<span class="number">201701</span>, <span class="number">201702</span>, <span class="number">201703</span>, <span class="number">201704</span>, <span class="number">201705</span>, <span class="number">201706</span>, <span class="number">201707</span>, <span class="number">201708</span>, <span class="number">201709</span>, <span class="number">201710</span>, <span class="number">201711</span>, <span class="number">201712</span>),</span><br><span class="line">    <span class="keyword">PARTITION</span> p1 <span class="keyword">VALUES</span> <span class="keyword">IN</span> (<span class="number">201801</span>, <span class="number">201802</span>, <span class="number">201803</span>, <span class="number">201804</span>, <span class="number">201805</span>, <span class="number">201806</span>, <span class="number">201807</span>, <span class="number">201808</span>, <span class="number">201809</span>, <span class="number">201810</span>, <span class="number">201811</span>, <span class="number">201812</span>),</span><br><span class="line">    <span class="keyword">PARTITION</span> p2 <span class="keyword">VALUES</span> <span class="keyword">IN</span> (<span class="number">201901</span>, <span class="number">201902</span>, <span class="number">201903</span>, <span class="number">201904</span>, <span class="number">201905</span>, <span class="number">201906</span>, <span class="number">201907</span>, <span class="number">201908</span>, <span class="number">201909</span>, <span class="number">201910</span>, <span class="number">201911</span>, <span class="number">201912</span>),</span><br><span class="line">    <span class="keyword">PARTITION</span> p3 <span class="keyword">VALUES</span> <span class="keyword">IN</span> (<span class="number">202001</span>, <span class="number">202002</span>, <span class="number">202003</span>, <span class="number">202004</span>, <span class="number">202005</span>, <span class="number">202006</span>, <span class="number">202007</span>, <span class="number">202008</span>, <span class="number">202009</span>, <span class="number">202010</span>, <span class="number">202011</span>, <span class="number">202012</span>),</span><br><span class="line">    <span class="keyword">PARTITION</span> p4 <span class="keyword">VALUES</span> <span class="keyword">IN</span> (<span class="number">202101</span>, <span class="number">202102</span>, <span class="number">202103</span>, <span class="number">202104</span>, <span class="number">202105</span>, <span class="number">202106</span>, <span class="number">202107</span>, <span class="number">202108</span>, <span class="number">202109</span>, <span class="number">202110</span>, <span class="number">202111</span>, <span class="number">202112</span>),</span><br><span class="line">    <span class="keyword">PARTITION</span> p5 <span class="keyword">VALUES</span> <span class="keyword">IN</span> (<span class="number">202201</span>, <span class="number">202202</span>, <span class="number">202203</span>, <span class="number">202204</span>, <span class="number">202205</span>, <span class="number">202206</span>, <span class="number">202207</span>, <span class="number">202208</span>, <span class="number">202209</span>, <span class="number">202210</span>, <span class="number">202211</span>, <span class="number">202212</span>)</span><br><span class="line">);</span><br></pre></td></tr></table></figure>

<p>list 的分区精确查询和范围查询都能使用其分区策略</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; explain select * from list where c = 1 and g = &#x27;AD&#x27; and m between 201701 and 201803 limit 1 \G;</span><br><span class="line">*************************** 1. row ***************************</span><br><span class="line">           id: 1</span><br><span class="line">  select_type: SIMPLE</span><br><span class="line">        table: list</span><br><span class="line">   partitions: p0,p1</span><br><span class="line">         type: ref</span><br><span class="line">possible_keys: product-country</span><br><span class="line">          key: product-country</span><br><span class="line">      key_len: 10</span><br><span class="line">          ref: const,const</span><br><span class="line">         rows: 12</span><br><span class="line">     filtered: 11.11</span><br><span class="line">        Extra: Using where; Using index</span><br><span class="line">1 row in set, 1 warning (0.01 sec)</span><br></pre></td></tr></table></figure>

<p>从建表语句可以看到，分区的字段的值是明确的，如果插入的数据不在指定的数据内，会报错。与 range 相比，你的数据分区可以由你自己指定，但是不能选择 MAXVALUE 类似的值，所以你必须提前规划好所有可能的值，包括是否分配均匀也是由自己确定。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; insert into list values (1, 2 ,3 ,4, 5, 6, &#x27;CN&#x27;, &#x27;2050-06-06&#x27;, 205006);</span><br><span class="line">ERROR 1526 (HY000): Table has no partition for value from column_list</span><br></pre></td></tr></table></figure>

<h2 id="写在后面"><a href="#写在后面" class="headerlink" title="写在后面"></a>写在后面</h2><p>在分区之后，也可以通过相应的语句查询分区是否平均</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">mysql&gt; select PARTITION_NAME, TABLE_ROWS FROM INFORMATION_SCHEMA.PARTITIONS where table_name = &#x27;origin&#x27;;</span><br><span class="line">+----------------+------------+</span><br><span class="line">| PARTITION_NAME | TABLE_ROWS |</span><br><span class="line">+----------------+------------+</span><br><span class="line">| p0             |      11520 |</span><br><span class="line">| p1             |      13152 |</span><br><span class="line">| p2             |      13152 |</span><br><span class="line">| p3             |      12640 |</span><br><span class="line">| p4             |      11472 |</span><br><span class="line">| p5             |      12911 |</span><br><span class="line">| p6             |      12864 |</span><br><span class="line">| p7             |      12288 |</span><br><span class="line">+----------------+------------+</span><br></pre></td></tr></table></figure>

<p>这里主要讲了三种分区策略，其实 hash 还包括另一种简单的 hash ，我测试中用的是 liner hash，可以理解为更为平均的 hash，文档可见 这里。三种分区的策略简单如下</p>
<ul>
<li>hash：适用于数据范围较分散或者说暂不明确上下限，最后的查询也不涉及范围查询的情况；</li>
<li>range：适合于数据需要范围查询的，并且需要数据的分布也分区的字段有关；</li>
<li>list：适用于数据范围明确的，数据范围需要自己去控制。</li>
</ul>
<p>与 hash 相比，range 和 list 也都是后期通过增加相应的分区而不移动数据的，如果是 hash 修改分区策略的话就会涉及到数据的移动</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; alter table `origin` partition by linear hash(YEAR(`h`)) partitions 2;</span><br><span class="line">Query OK, 99999 rows affected (15.25 sec)</span><br><span class="line"></span><br><span class="line">mysql&gt; alter table `list` ADD partition (partition p6 values IN (202301, 202302));</span><br><span class="line">Query OK, 0 rows affected (0.94 sec)</span><br><span class="line">Records: 0  Duplicates: 0  Warnings: 0</span><br></pre></td></tr></table></figure>

<p>还有需要注意的是，如果在 range 中使用了 MAXVALUE 的话，该分区必须是最后一个分区的定义，并且你也不能往这个表加分区了</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; alter table `month_field` ADD partition (partition p61 values less than(201708));</span><br><span class="line">ERROR 1481 (HY000): MAXVALUE can only be used in last partition definition</span><br></pre></td></tr></table></figure>


<h2 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h2><ol>
<li><a target="_blank" rel="noopener" href="https://dev.mysql.com/doc/refman/5.7/en/partitioning.html">MySQL 5.7 分区模块文档</a></li>
<li><a target="_blank" rel="noopener" href="http://haitian299.github.io/2016/05/26/mysql-partitioning/">分区，分表，分库的应用场景</a></li>
<li><a target="_blank" rel="noopener" href="https://dev.mysql.com/doc/refman/5.7/en/alter-table-partition-operations.html">修改 MySQL 表分区</a></li>
</ol>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://yoursite.com/2017/08/26/mysql-partitions/" data-id="ckv3iop6q0015esc8cvnr995i" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/mysql/" rel="tag">mysql</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/partitions/" rel="tag">partitions</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-python-abstact-class" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2017/06/17/python-abstact-class/" class="article-date">
  <time datetime="2017-06-16T16:00:00.000Z" itemprop="datePublished">2017-06-17</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2017/06/17/python-abstact-class/">Python 中的虚拟基类</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>Python 这类动态类型语言，Duck Typing 是一个比较突出的优点。属性，方法的惰性计算，给代码的编写带来了高度的灵活性。当然有利有弊，Duck Typing 这东西在 Python 中更多是一种规范，而不是强制约束。如果我们需要约束这些接口，需要做些什么呢？</p>
<h2 id="运行时检查"><a href="#运行时检查" class="headerlink" title="运行时检查"></a>运行时检查</h2><p>下面看一下简单的例子，这是个比较常见的场景，通过基类定义了一系列的接口，然后继承的子类根据自己特定的需求实现具体的接口。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Animal</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">action</span>(<span class="params">self</span>):</span></span><br><span class="line">        <span class="keyword">raise</span> NotImplementedError()</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Bird</span>(<span class="params">Animal</span>):</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">action</span>(<span class="params">self</span>):</span></span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;fly&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Dog</span>(<span class="params">Animal</span>):</span></span><br><span class="line">    <span class="keyword">pass</span></span><br><span class="line"></span><br><span class="line">bird = Bird()</span><br><span class="line">dog = Dog()</span><br><span class="line"></span><br><span class="line">animals = [Bird(), Dog()]</span><br><span class="line"><span class="keyword">for</span> animal <span class="keyword">in</span> animals:</span><br><span class="line">    <span class="built_in">print</span>(animal.action())</span><br><span class="line"></span><br><span class="line"><span class="comment"># 输出如下：</span></span><br><span class="line"><span class="comment"># fly</span></span><br><span class="line"><span class="comment"># Traceback (most recent call last):</span></span><br><span class="line"><span class="comment">#  File &quot;test.py&quot;, line 22, in &lt;module&gt;</span></span><br><span class="line"><span class="comment">#    print(animal.action())</span></span><br><span class="line"><span class="comment">#  File &quot;test.py&quot;, line 4, in action</span></span><br><span class="line"><span class="comment">#    raise NotImplementedError()</span></span><br><span class="line"><span class="comment"># NotImplementedError</span></span><br></pre></td></tr></table></figure>

<p>我们可以看到，Animal 的 action 的确是会抛出异常，但如果子类实现了该方法，则相应的方法查找则会屏蔽掉基类的该方法而使用自己当前的版本。</p>
<p>这的确是能实现简单的抽象方法的概念，但是，该错误直到运行时才能暴露出来。极端点的情况，你可能还要去判断这个 name 是否可以调用，调用的参数对不对。</p>
<h2 id="抽象基类"><a href="#抽象基类" class="headerlink" title="抽象基类"></a>抽象基类</h2><p>Python 本身是支持抽象基类的，最常用的是 collections 里面提供的一些抽象类。如常见的用于判断类型</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> collections</span><br><span class="line"><span class="built_in">isinstance</span>([], collections.MutableSequence) <span class="comment"># True</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 还有数类型</span></span><br><span class="line"><span class="keyword">import</span> numbers</span><br><span class="line"><span class="built_in">isinstance</span>(<span class="number">12313.123</span>, numbers.Number) <span class="comment"># True</span></span><br></pre></td></tr></table></figure>

<p>如果我们用来实现序列，那就更简单了</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> collections</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Sequence</span>(<span class="params">collections.MutableSequence</span>):</span></span><br><span class="line">    <span class="keyword">pass</span></span><br><span class="line"></span><br><span class="line">seq = <span class="type">Sequence</span>()</span><br><span class="line"></span><br><span class="line"><span class="comment"># Traceback (most recent call last):</span></span><br><span class="line"><span class="comment">#   File &quot;test.py&quot;, line 8, in &lt;module&gt;</span></span><br><span class="line"><span class="comment">#     seq = Sequence()</span></span><br><span class="line"><span class="comment"># TypeError: Can&#x27;t instantiate abstract class Sequence with abstract methods # __delitem__, __getitem__, __len__, __setitem__, insert</span></span><br></pre></td></tr></table></figure>

<p>跟之前的代码相比，这个是在实例化的时候进行检查的，你继承了某些抽象类之后，在实例化的时候，会去检查是否有实现具体的方法。collections 中还有其它的基础类型的抽象类，如果要实现相应协议的话，可以去看看。</p>
<h2 id="自定义抽象类"><a href="#自定义抽象类" class="headerlink" title="自定义抽象类"></a>自定义抽象类</h2><p>同样的，我们也可以实现自己的抽象基类，然后通过具体的子类去定义具体的行为</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> abc</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Base</span>(<span class="params">abc.ABC</span>):</span></span><br><span class="line"><span class="meta">    @abc.abstractmethod</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">name</span>(<span class="params">self</span>):</span></span><br><span class="line">        <span class="string">&#x27;&#x27;&#x27; just docs</span></span><br><span class="line"><span class="string">        &#x27;&#x27;&#x27;</span></span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;Base&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">A</span>(<span class="params">Base</span>):</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">name</span>(<span class="params">self</span>):</span></span><br><span class="line">        <span class="keyword">return</span> self.__class__.__name__</span><br><span class="line"></span><br><span class="line">a = A()</span><br><span class="line"><span class="built_in">print</span>(a.name())</span><br></pre></td></tr></table></figure>

<p>上述代码中，如果类 A 不定义 name 的方法，则会抛出 TypeError 的异常。但实际上，如果我们去修改 Base 中 name 的函数签名，例如加个参数什么的，上述代码依旧是能正常运行的。这样子的话，其实 Python 本身支持的抽象方法只是检验是否有这个可调用的类成员。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">A</span>(<span class="params">Base</span>):</span></span><br><span class="line">    name = <span class="built_in">print</span></span><br><span class="line">    <span class="comment"># name = 1</span></span><br><span class="line">    <span class="comment"># TypeError: &#x27;int&#x27; object is not callable</span></span><br></pre></td></tr></table></figure>

<h2 id="再看鸭子类型"><a href="#再看鸭子类型" class="headerlink" title="再看鸭子类型"></a>再看鸭子类型</h2><p>最开始接触 Python 的时候，觉得这一特性很好用啊，例如我要处理一大串对象，只要里面的对象实现了这个方法，就可以都扔到同一个队列里面进行处理，但这个东西很容易滥用。如果你在处理之后需要相应的回调，这又必须跑去实现回调函数，但因为函数调用的检查是在处理该对象的时候，如果忘了某些对象的相应方法，可能最后上线才能发现问题。</p>
<p>接触了一阵子的 golang，使用 interface 之后简直如沐春风，运行时的错误在编译阶段就能避免了，减少了很多查 bug 的时间。在这一点上，如果需要使用类似的特性，python 对程序员的能力要求反而更高了。</p>
<p>我个人比较推崇先去判断这个对象是什么类型，如判断它是不是可以迭代的，可调用的，这样子，你就知道了该对象支持什么样的方法。如果不行再去判断是否实现了具体的方法。当然，运行时去判断这些东西是有消耗的，具体的需要就要看业务场景了。</p>
<p>灵活是抛弃了一些约束的结果，没有了约束效率就会低下，哪样较好没有绝对的定论。</p>
<h2 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h2><ol>
<li><a target="_blank" rel="noopener" href="https://docs.python.org/3/library/abc.html">Python abc 库的文档</a></li>
</ol>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://yoursite.com/2017/06/17/python-abstact-class/" data-id="ckv3iop6p0014esc85cva5z7j" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/python/" rel="tag">python</a></li></ul>

    </footer>
  </div>
  
</article>


  


  <nav id="page-nav">
    
    <a class="extend prev" rel="prev" href="/">&amp;laquo; Prev</a><a class="page-number" href="/">1</a><span class="page-number current">2</span><a class="page-number" href="/page/3/">3</a><a class="page-number" href="/page/4/">4</a><a class="page-number" href="/page/5/">5</a><a class="extend next" rel="next" href="/page/3/">Next &amp;raquo;</a>
  </nav>

</section>
        
          <aside id="sidebar">
  
    

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Tags</h3>
    <div class="widget">
      <ul class="tag-list" itemprop="keywords"><li class="tag-list-item"><a class="tag-list-link" href="/tags/annotation/" rel="tag">annotation</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/architecture/" rel="tag">architecture</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/blog/" rel="tag">blog</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/ci/" rel="tag">ci</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/concurrency/" rel="tag">concurrency</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/container/" rel="tag">container</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/context/" rel="tag">context</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/database/" rel="tag">database</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/debug/" rel="tag">debug</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/docker/" rel="tag">docker</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/encoding/" rel="tag">encoding</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/engineering/" rel="tag">engineering</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/error/" rel="tag">error</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/eval/" rel="tag">eval</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/generic/" rel="tag">generic</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/git/" rel="tag">git</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/golang/" rel="tag">golang</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/http/" rel="tag">http</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/https/" rel="tag">https</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/influxdb/" rel="tag">influxdb</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/innodb/" rel="tag">innodb</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/java/" rel="tag">java</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/javascript/" rel="tag">javascript</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/jenkins/" rel="tag">jenkins</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/k8s/" rel="tag">k8s</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/lambda/" rel="tag">lambda</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/memory-leak/" rel="tag">memory-leak</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/metaclass/" rel="tag">metaclass</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/metrics/" rel="tag">metrics</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/microservice/" rel="tag">microservice</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/mock/" rel="tag">mock</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/mysql/" rel="tag">mysql</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/network/" rel="tag">network</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/nginx/" rel="tag">nginx</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/partitions/" rel="tag">partitions</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/patch/" rel="tag">patch</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/pipeline/" rel="tag">pipeline</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/protocol/" rel="tag">protocol</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/proxy/" rel="tag">proxy</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/python/" rel="tag">python</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/react/" rel="tag">react</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/reflect/" rel="tag">reflect</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/security/" rel="tag">security</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/ssl/" rel="tag">ssl</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/sync/" rel="tag">sync</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/tcp/" rel="tag">tcp</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/thread/" rel="tag">thread</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/timezone/" rel="tag">timezone</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/tls/" rel="tag">tls</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/traefik/" rel="tag">traefik</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/ubuntu/" rel="tag">ubuntu</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/unittest/" rel="tag">unittest</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/virtualenv/" rel="tag">virtualenv</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/virtualenvwrapper/" rel="tag">virtualenvwrapper</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Tag Cloud</h3>
    <div class="widget tagcloud">
      <a href="/tags/annotation/" style="font-size: 10px;">annotation</a> <a href="/tags/architecture/" style="font-size: 10px;">architecture</a> <a href="/tags/blog/" style="font-size: 10px;">blog</a> <a href="/tags/ci/" style="font-size: 10px;">ci</a> <a href="/tags/concurrency/" style="font-size: 10px;">concurrency</a> <a href="/tags/container/" style="font-size: 10px;">container</a> <a href="/tags/context/" style="font-size: 10px;">context</a> <a href="/tags/database/" style="font-size: 10px;">database</a> <a href="/tags/debug/" style="font-size: 10px;">debug</a> <a href="/tags/docker/" style="font-size: 17.5px;">docker</a> <a href="/tags/encoding/" style="font-size: 12.5px;">encoding</a> <a href="/tags/engineering/" style="font-size: 10px;">engineering</a> <a href="/tags/error/" style="font-size: 10px;">error</a> <a href="/tags/eval/" style="font-size: 10px;">eval</a> <a href="/tags/generic/" style="font-size: 10px;">generic</a> <a href="/tags/git/" style="font-size: 10px;">git</a> <a href="/tags/golang/" style="font-size: 20px;">golang</a> <a href="/tags/http/" style="font-size: 10px;">http</a> <a href="/tags/https/" style="font-size: 10px;">https</a> <a href="/tags/influxdb/" style="font-size: 10px;">influxdb</a> <a href="/tags/innodb/" style="font-size: 10px;">innodb</a> <a href="/tags/java/" style="font-size: 17.5px;">java</a> <a href="/tags/javascript/" style="font-size: 10px;">javascript</a> <a href="/tags/jenkins/" style="font-size: 10px;">jenkins</a> <a href="/tags/k8s/" style="font-size: 12.5px;">k8s</a> <a href="/tags/lambda/" style="font-size: 10px;">lambda</a> <a href="/tags/memory-leak/" style="font-size: 10px;">memory-leak</a> <a href="/tags/metaclass/" style="font-size: 10px;">metaclass</a> <a href="/tags/metrics/" style="font-size: 10px;">metrics</a> <a href="/tags/microservice/" style="font-size: 10px;">microservice</a> <a href="/tags/mock/" style="font-size: 10px;">mock</a> <a href="/tags/mysql/" style="font-size: 12.5px;">mysql</a> <a href="/tags/network/" style="font-size: 10px;">network</a> <a href="/tags/nginx/" style="font-size: 15px;">nginx</a> <a href="/tags/partitions/" style="font-size: 10px;">partitions</a> <a href="/tags/patch/" style="font-size: 10px;">patch</a> <a href="/tags/pipeline/" style="font-size: 10px;">pipeline</a> <a href="/tags/protocol/" style="font-size: 10px;">protocol</a> <a href="/tags/proxy/" style="font-size: 10px;">proxy</a> <a href="/tags/python/" style="font-size: 20px;">python</a> <a href="/tags/react/" style="font-size: 10px;">react</a> <a href="/tags/reflect/" style="font-size: 10px;">reflect</a> <a href="/tags/security/" style="font-size: 12.5px;">security</a> <a href="/tags/ssl/" style="font-size: 10px;">ssl</a> <a href="/tags/sync/" style="font-size: 10px;">sync</a> <a href="/tags/tcp/" style="font-size: 10px;">tcp</a> <a href="/tags/thread/" style="font-size: 10px;">thread</a> <a href="/tags/timezone/" style="font-size: 10px;">timezone</a> <a href="/tags/tls/" style="font-size: 10px;">tls</a> <a href="/tags/traefik/" style="font-size: 10px;">traefik</a> <a href="/tags/ubuntu/" style="font-size: 10px;">ubuntu</a> <a href="/tags/unittest/" style="font-size: 10px;">unittest</a> <a href="/tags/virtualenv/" style="font-size: 10px;">virtualenv</a> <a href="/tags/virtualenvwrapper/" style="font-size: 10px;">virtualenvwrapper</a>
    </div>
  </div>

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Archives</h3>
    <div class="widget">
      <ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2021/10/">十月 2021</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/11/">十一月 2020</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/09/">九月 2020</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/08/">八月 2020</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/06/">六月 2020</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/10/">十月 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/01/">一月 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/12/">十二月 2018</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/10/">十月 2018</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/09/">九月 2018</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/08/">八月 2018</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/07/">七月 2018</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/10/">十月 2017</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/08/">八月 2017</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/06/">六月 2017</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/05/">五月 2017</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/03/">三月 2017</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/01/">一月 2017</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/12/">十二月 2016</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/10/">十月 2016</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/08/">八月 2016</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/07/">七月 2016</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/06/">六月 2016</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/05/">五月 2016</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/03/">三月 2016</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2015/12/">十二月 2015</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2015/10/">十月 2015</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2015/08/">八月 2015</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Recent Posts</h3>
    <div class="widget">
      <ul>
        
          <li>
            <a href="/2021/10/23/oauth-introduction/">OAuth Introduction</a>
          </li>
        
          <li>
            <a href="/2020/11/13/mysql-innodb/">MySQL InnoDB Introduction</a>
          </li>
        
          <li>
            <a href="/2020/09/14/cloud-design-patterns/">Cloud Design Patterns</a>
          </li>
        
          <li>
            <a href="/2020/08/21/about-ssl-tls/">About SSL And TLS</a>
          </li>
        
          <li>
            <a href="/2020/06/07/nginx-stream-debug/">Nginx stream debug</a>
          </li>
        
      </ul>
    </div>
  </div>

  
</aside>
        
      </div>
      <footer id="footer">
  
  <div class="outer">
    <div id="footer-info" class="inner">
      &copy; 2021 Shing<br>
      Powered by <a href="http://hexo.io/" target="_blank">Hexo</a>
    </div>
  </div>
</footer>
    </div>
    <nav id="mobile-nav">
  
    <a href="/" class="mobile-nav-link">Home</a>
  
    <a href="/archives" class="mobile-nav-link">Archives</a>
  
</nav>
    

<script src="//ajax.googleapis.com/ajax/libs/jquery/2.0.3/jquery.min.js"></script>


  
<link rel="stylesheet" href="/fancybox/jquery.fancybox.css">

  
<script src="/fancybox/jquery.fancybox.pack.js"></script>




<script src="/js/script.js"></script>




  </div>
</body>
</html>